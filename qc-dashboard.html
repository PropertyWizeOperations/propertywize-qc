<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PropertyWize QC Hub</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* CSS STYLES */
:root { --primary: #003366; --accent: #28a745; --danger: #dc3545; --warning: #ffc107; --light: #f4f6f9; }
body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
.navbar { background: var(--primary); color: white; padding: 10px 30px; display: flex; align-items: center; height: 70px; gap: 20px; z-index:100; position:relative;}
.brand { font-size: 1.4rem; font-weight: bold; margin-right: auto; display:flex; align-items:center; gap:10px; }
.auditor-box { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 4px; }
.auditor-input { background: transparent; border: none; color: white; font-weight: bold; font-size: 1rem; border-bottom: 1px solid rgba(255,255,255,0.5); width: 150px; }
.auditor-input:focus { outline: none; border-bottom: 2px solid var(--accent); }
.mode-select { padding: 8px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; color: var(--primary); background: #fff; }
.logo-upload-container { width: 180px; height: 55px; background: white; border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px dashed #cbd5e0; transition: 0.2s; position: relative; }
.logo-upload-container:hover { border-color: var(--accent); }
.logo-upload-container img { max-height: 100%; max-width: 100%; object-fit: contain; }
.logo-text { font-size: 0.8rem; color: #555; font-weight: bold; text-align: center; }

.container { display: flex; flex: 1; overflow: hidden; }
.sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
.main-content { flex: 1; padding: 30px; overflow-y: auto; }
.nav-item { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: 500; display:flex; align-items:center; gap:10px; }
.nav-item.active { background: #e8f5e9; color: var(--primary); border-left: 4px solid var(--accent); }
.card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
.drop-zone { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; display:flex; flex-direction:column; align-items:center; gap:5px; }
.drop-zone.uploaded { border-color: var(--accent); background: #e8f5e9; }
.scanned-data { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; background: #eef2f7; padding: 15px; border-radius: 6px; }
input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
.btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; margin-right: 5px; }
.btn-primary { background: var(--primary); color: white; }
.btn-accent { background: var(--accent); color: white; }
.btn-outline { border: 1px solid #ccc; background: white; }
.btn-warn { background: var(--warning); color: #333; }
.btn-danger { background: var(--danger); color: white; }
.btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }

/* ALERTS & SCORECARD */
.tat-alert-box { background: #ffebee; border: 1px solid #ffcdd2; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; border-left: 5px solid var(--danger); }
.tat-header { color: #c62828; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
.score-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom:20px; }
.score-box { text-align:center; padding:20px; background:#f8f9fa; border-radius:8px; border:1px solid #eee; }
.score-val { font-size:2rem; font-weight:bold; color:var(--primary); margin:0; }
.score-label { color:#666; font-size:0.9rem; text-transform:uppercase; }
.feedback-box { background: #e8f5e9; border-left: 5px solid #28a745; padding: 20px; margin-bottom: 20px; border-radius: 4px; }
.feedback-header { font-weight: bold; font-size: 1.1rem; color: #155724; margin-bottom: 10px; }

/* UI ELEMENTS */
.buildium-check-box { background: #e8f0fe; border: 1px solid #4285f4; padding:20px; border-radius:8px; margin-bottom:20px; }
.toggle-row { display: flex; gap: 20px; align-items: center; background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ccc; }
.badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
.bg-pass { background: #d4edda; color: #155724; } 
.bg-fail { background: #f8d7da; color: #721c24; }
.bg-warn { background: #fff3cd; color: #856404; }
.bg-blue { background: #cce5ff; color: #004085; }
.status-action { background-color: #fefcbf; color: #744210; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; border: 1px solid #f6e05e; cursor: pointer; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(246, 224, 94, 0.7); } 70% { box-shadow: 0 0 0 5px rgba(246, 224, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(246, 224, 94, 0); } }
.icon-warning { color: #d69e2e; margin-left: 5px; }

/* MODALS */
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; backdrop-filter: blur(2px); }
.modal { background:white; padding:25px; border-radius:8px; width:600px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
.modal-header { font-size:1.2rem; font-weight:bold; margin-bottom:15px; color:var(--primary); display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding-bottom:10px; }
.error-msg { color: #e53e3e; font-size: 0.8rem; margin-top: 5px; display: none; font-weight: bold; background: #fff5f5; padding:5px; border-left:3px solid #e53e3e; }

/* PDF TEMPLATE - HIDDEN BUT DOM-ACCESSIBLE */
#pdf-template { display: none; width: 750px; padding: 20px; font-family: 'Helvetica', sans-serif; background: white; color: #333; box-sizing: border-box; }
.pdf-header-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border-bottom: 3px solid #003366; padding-bottom: 10px; }
.pdf-header-table td { vertical-align: middle; }
.pdf-logo-cell { text-align: left; width: 40%; }
.pdf-info-cell { text-align: right; width: 60%; }
.pdf-title { font-size: 24px; font-weight: bold; color: #003366; margin-bottom: 5px; }
.pdf-meta { font-size: 13px; color: #555; line-height: 1.4; }
.pdf-logo-img { max-height: 65px; max-width: 220px; }
.pdf-methodology { background: #eef2f7; padding: 10px; border-left: 4px solid #003366; margin-bottom: 15px; font-size: 13px; color: #444; }
</style>
</head>
<body onload="initApp()">

<div class="modal-overlay" id="updateModal">
    <div class="modal">
        <div class="modal-header"><i class="fas fa-exclamation-triangle" style="color:var(--warning);"></i> Clear Rent Stagnation</div>
        <label>1. Resolution Reason</label>
        <select id="modalOpsReason" style="margin-bottom:15px; width:100%;">
            <option value="">-- Select --</option>
            <option value="Owner elected to keep rent same">1. Owner elected to keep rent same</option>
            <option value="Managed < 12 months">2. Managed < 12 months</option>
            <option value="Missed requirement (Will submit)">3. Missed requirement (Will submit)</option>
            <option value="Other">4. Other</option>
        </select>
        <label>2. Ref ID</label>
        <input type="text" id="modalRefId" placeholder="Task #12345" style="margin-bottom:5px;">
        <label>3. Notes</label>
        <textarea id="modalNotes" rows="3" style="margin-bottom:10px; width:100%;"></textarea>
        <div style="text-align:right;">
            <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-accent" onclick="confirmUpdate()">Resolve</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="actionModal">
    <div class="modal">
        <div class="modal-header" id="modalTitle">Action Required</div>
        <p id="modalDesc" style="font-size:0.9rem; color:#666;"></p>
        <label>Response / Notes</label>
        <textarea id="modalComment" rows="12" style="margin-bottom:10px; width:100%; font-family:monospace; font-size:0.85rem; white-space: pre-wrap;"></textarea>
        <div style="text-align:right;">
            <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-accent" onclick="confirmAction()">Submit</button>
        </div>
    </div>
</div>

<div id="pdf-template">
    <table class="pdf-header-table">
        <tr>
            <td class="pdf-logo-cell"><img id="pdfLogo" class="pdf-logo-img"></td>
            <td class="pdf-info-cell">
                <div class="pdf-title">AUDIT REPORT</div>
                <div class="pdf-meta">
                    <strong>Date:</strong> <span id="pdf-gen-date"></span><br>
                    <strong>QC Ref:</strong> <span id="pdf-qc-ref"></span><br>
                    <strong>Status:</strong> <span id="pdf-header-status"></span>
                </div>
            </td>
        </tr>
    </table>
    <div style="background: #f4f6f9; padding:15px; border-radius:5px; margin-bottom: 25px; border:1px solid #ddd;">
        <table style="width:100%; border-collapse: collapse; font-size:13px;">
            <tr>
                <td style="padding:5px; width:50%;"><strong>Audit Type:</strong> <span id="pdf-type"></span></td>
                <td style="padding:5px;"><strong>Auditor:</strong> <span id="pdf-auditor"></span></td>
            </tr>
            <tr>
                <td style="padding:5px;"><strong>Property:</strong> <span id="pdf-property"></span></td>
                <td style="padding:5px;"><strong>Assignee:</strong> <span id="pdf-assignee"></span></td>
            </tr>
            <tr>
                <td style="padding:5px;"><strong>Task #:</strong> <span id="pdf-task"></span></td>
                <td style="padding:5px;"><strong>Tenant:</strong> <span id="pdf-tenant"></span></td>
            </tr>
        </table>
    </div>
    <h3>Audit Methodology</h3>
    <div id="pdf-methodology" class="pdf-methodology"></div>
    <h3>Detailed Findings</h3>
    <div id="pdf-content" style="line-height: 1.6; font-size:13px; white-space: pre-wrap; font-family: monospace;"></div>
    
    <div id="pdf-ops-section" style="display:none; margin-top:20px; border-top:2px dashed #ccc; padding-top:10px;">
        <h4 style="margin-bottom:5px; color:#d69e2e;">‚ö†Ô∏è Operational Flag Resolved</h4>
        <table style="width:100%; font-size:12px; border-collapse:collapse;">
            <tr>
                <td style="padding:4px; font-weight:bold; width:100px;">Status:</td>
                <td style="padding:4px;"><span id="pdf-ops-status" style="color:green; font-weight:bold;"></span></td>
            </tr>
            <tr>
                <td style="padding:4px; font-weight:bold;">Resolution:</td>
                <td style="padding:4px;"><span id="pdf-ops-reason"></span></td>
            </tr>
            <tr>
                <td style="padding:4px; font-weight:bold;">Proof / Ref:</td>
                <td style="padding:4px;"><span id="pdf-ops-ref"></span></td>
            </tr>
            <tr>
                <td style="padding:4px; font-weight:bold; vertical-align:top;">Notes:</td>
                <td style="padding:4px; font-style:italic;"><span id="pdf-ops-notes"></span></td>
            </tr>
        </table>
    </div>
</div>

<div class="navbar">
    <div class="brand"><i class="fas fa-shield-alt"></i> PropertyWize QC Hub</div>
    <div class="auditor-box">
        <i class="fas fa-user"></i>
        <input type="text" id="globalAuditor" class="auditor-input" placeholder="Auditor Name" onchange="saveAuditorName()">
    </div>
    <select id="auditTypeSelect" class="mode-select" onchange="toggleAuditMode()">
        <option value="ledger">Tenant Ledger Audit</option>
        <option value="mgmt">Management Fee Audit</option>
    </select>
    <div class="logo-upload-container" onclick="document.getElementById('logoInput').click()">
        <span class="logo-text" id="logoText"><i class="fas fa-upload"></i> <span id="logoTextLabel">Click to Add Logo</span></span>
        <img id="logoPreview" style="display:none;">
        <input type="file" id="logoInput" accept="image/*" style="display:none" onchange="loadLogo(this)">
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="nav-item active" id="navAudit" onclick="showTab('auditTab')"><i class="fas fa-magic"></i> New Audit</div>
        <div class="nav-item" onclick="showTab('historyTab')"><i class="fas fa-history"></i> Audit Log</div>
        <div class="nav-item" onclick="showTab('scoreTab')"><i class="fas fa-chart-bar"></i> Scorecard</div>
        <div style="margin-top:auto; padding:20px;">
            <div id="dbStatus" style="font-size:0.7rem; color:#888; margin-bottom:10px;">üî¥ Not Connected</div>
            <button class="btn btn-warn" onclick="clearSystemData()"><i class="fas fa-trash"></i> Reset Data</button>
        </div>
    </div>

    <div class="main-content">
        <div id="tatAlertBox" class="tat-alert-box" style="display:none;">
            <div class="tat-header"><i class="fas fa-clock"></i> üö® OVERDUE FOLLOW-UP REQUIRED (>1 Business Day)</div>
            <p>The following audits are pending Assignee Action and have exceeded the 24-hour turnaround time.</p>
            <ul id="tatList" style="margin:10px 0; font-weight:bold;"></ul>
            <textarea id="tatEmailTemplate" rows="4" readonly style="width:100%; border:1px solid #ffcdd2; background:#fff; font-size:0.8rem;"></textarea>
            <button class="btn btn-danger" onclick="copyTatEmail()" style="margin-top:5px;">Copy Follow-Up Note</button>
        </div>

        <div id="scoreTab" style="display:none;">
            <h2>Performance Scorecard</h2>
            <div id="feedbackBox" class="feedback-box">
                <div class="feedback-header">Performance Review & Feedback</div>
                <div id="feedbackText">Loading stats...</div>
            </div>
            <div class="score-grid">
                <div class="score-box"><h1 class="score-val" id="scoreTotal">0</h1><div class="score-label">Total Audits</div></div>
                <div class="score-box"><h1 class="score-val" id="scorePass" style="color:var(--accent);">0%</h1><div class="score-label">Pass Rate</div></div>
                <div class="score-box"><h1 class="score-val" id="scorePenalty" style="color:var(--danger);">$0</h1><div class="score-label">Total Penalties</div></div>
            </div>
        </div>

        <div id="auditTab">
            
            <div id="ledgerAuditSection">
                <h2><i class="fas fa-file-invoice-dollar"></i> Tenant Ledger Audit</h2>
                <div class="card">
                    <div style="display:flex; justify-content:space-between;"><h3>1. Audit Intake</h3><div style="font-weight:bold; color:var(--primary);">QC Ref: <span id="qcRefDisplay">...</span></div></div>
                    <div class="toggle-row">
                        <label style="font-weight:bold; color:#003366;">Did Rent Change in the last 12 months?</label>
                        <select id="rentChangeToggle" onchange="toggleRentChange()" style="width:auto;">
                            <option value="no">No (Constant Rent)</option>
                            <option value="yes">Yes (1 Change)</option>
                            <option value="multi">Yes (Multiple/Custom)</option>
                        </select>
                    </div>
                    
                    <div class="scanned-data" style="grid-template-columns: 1fr 1fr;">
                        <div><label>Buildium Task Assignee</label><input type="text" id="assignVA" placeholder="e.g. Finance"></div>
                        <div><label>Buildium Task #</label><input type="text" id="mainTaskNumber" placeholder="#12345"></div>
                        <div><label>Tenant Name</label><input type="text" id="scanTenant"></div>
                        <div><label>Property Address</label><input type="text" id="propAddress"></div>
                    </div>
                    <hr style="border-top:1px solid #eee; margin:20px 0;">
                    <div class="buildium-check-box">
                        <label style="font-size:1.1rem; color:#003366; display:block; margin-bottom:10px;"><i class="fas fa-search"></i> <strong>Rent Verification</strong></label>
                        
                        <div style="margin-top:15px; margin-bottom:15px; background:#fff8e1; padding:15px; border-radius:6px; border-left:5px solid #ff9800; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-weight:bold; color:#e65100; display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                                <i class="fas fa-info-circle"></i> Section 8 / Tenant Portion Workflow
                            </div>
                            
                            <label style="cursor:pointer; display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <input type="checkbox" id="excludeHap" style="width:18px; height:18px; accent-color:#ff9800;">
                                <span style="font-weight:bold; font-size:1rem; color:#333;">Audit Tenant Portion Only</span>
                            </label>

                            <div style="font-size:0.85rem; color:#444; line-height:1.5; background:white; padding:10px; border:1px solid #ffeeba; border-radius:4px;">
                                <strong>When to use:</strong> Rent Income Charge (> $0.00) AND Subsidy/HAP/Section 8 Rent Charged (> $0.00).
                                <hr style="margin:8px 0; border:0; border-top:1px solid #eee;">
                                <strong>The Rule:</strong>
                                <ol style="margin:5px 0; padding-left:20px; gap: 5px; display: flex; flex-direction: column;">
                                    <li><strong>Check Ledger:</strong> Compare <em>Total Rent</em> (Tenant Charge + Subsidy Charge) on <strong>Jan 1</strong> vs <strong>Dec 1</strong>.</li>
                                    <li><strong>If Total Rent Changed:</strong> Select "Yes" above.</li>
                                    <li><strong>Data Entry:</strong> Enter <u>ONLY</u> the <strong>Tenant Portion</strong> in the Old/New Rent fields below (Do not enter the full rent).</li>
                                    <li><strong>If no portion/subsidy:</strong> Leave unchecked and use full rent.</li>
                                </ol>
                            </div>
                        </div>

                        <div id="logicConstant" style="display:block;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <div><label>Current Rent ($)</label><input type="number" id="rentConst" placeholder="1550.00"></div>
                                <div><label>Lease Start</label><input type="date" id="leaseStartInput"></div>
                            </div>
                        </div>
                        <div id="logicChanged" style="display:none; grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                            <div><label>Old Rent</label><input type="number" id="rentOld"></div>
                            <div><label>New Rent</label><input type="number" id="rentNew"></div>
                            <div><label>Month Changed</label>
                                <select id="changeMonth">
                                    <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                                    <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                                    <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                                </select>
                            </div>
                        </div>
                        <div id="logicCustom" style="display:none; margin-top:10px;">
                            <p style="font-size:0.8rem; color:#666; margin-bottom:5px;"><strong>Enter Tenant Portion for each month (For Multiple Changes/Sec 8 Flux):</strong></p>
                            <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:8px;">
                                <div><small>Jan</small><input type="number" id="r1" step="0.01"></div>
                                <div><small>Feb</small><input type="number" id="r2" step="0.01"></div>
                                <div><small>Mar</small><input type="number" id="r3" step="0.01"></div>
                                <div><small>Apr</small><input type="number" id="r4" step="0.01"></div>
                                <div><small>May</small><input type="number" id="r5" step="0.01"></div>
                                <div><small>Jun</small><input type="number" id="r6" step="0.01"></div>
                                <div><small>Jul</small><input type="number" id="r7" step="0.01"></div>
                                <div><small>Aug</small><input type="number" id="r8" step="0.01"></div>
                                <div><small>Sep</small><input type="number" id="r9" step="0.01"></div>
                                <div><small>Oct</small><input type="number" id="r10" step="0.01"></div>
                                <div><small>Nov</small><input type="number" id="r11" step="0.01"></div>
                                <div><small>Dec</small><input type="number" id="r12" step="0.01"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>2. Documents (Dual-File Audit)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        
                        <div class="drop-zone" id="dz-stmt" onclick="document.getElementById('stmtFile').click()">
                            <div><i class="fas fa-file-csv"></i> <strong>1. Tenant Ledger (CSV)</strong></div>
                            <div style="font-size:0.75rem; color:#666;">(Checks 5% Late Fee Rules)</div>
                            <input type="file" id="stmtFile" accept=".csv" style="display:none" onchange="processFile(this, 'csv')">
                            <div id="stmtStatus" style="color:var(--accent);"></div>
                        </div>

                        <div class="drop-zone" id="dz-pdf" onclick="document.getElementById('pdfFile').click()">
                            <div><i class="fas fa-file-pdf"></i> <strong>2. Ledger PDF (Print)</strong></div>
                            <div style="font-size:0.75rem; color:#666;">(Checks Misallocation Logic)</div>
                            <input type="file" id="pdfFile" accept=".pdf" style="display:none" onchange="processFile(this, 'ledgerPdf')">
                            <div id="pdfStatus" style="color:var(--accent);"></div>
                        </div>

                        <div class="drop-zone" id="dz-lease" onclick="document.getElementById('leaseFile').click()">
                            <div><i class="fas fa-file-contract"></i> <strong>3. Lease (PDF)</strong></div>
                            <input type="file" id="leaseFile" accept=".pdf" style="display:none" onchange="processFile(this, 'lease')">
                            <div id="leaseStatus" style="color:var(--accent);"></div>
                        </div>
                    </div>
                    <button class="btn btn-accent" style="margin-top:20px; width:100%;" onclick="runLedgerAudit()">üöÄ Run Comprehensive Audit</button>
                </div>
            </div>

            <div id="mgmtAuditSection" style="display:none;">
                <h2><i class="fas fa-percentage"></i> Management Fee Audit</h2>
                <div class="card">
                    <div style="display:flex; justify-content:space-between;"><h3>1. Agreement Parameters</h3><div style="font-weight:bold; color:var(--primary);">QC Ref: <span id="qcRefDisplayMgmt">...</span></div></div>
                    
                    <div class="scanned-data" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div><label>Property</label><input type="text" id="mgmtProp"></div>
                        <div><label>Buildium Task #</label><input type="text" id="mgmtTaskNum" placeholder="#12345"></div> 
                        <div><label>Assignee</label><input type="text" id="mgmtAssign" placeholder="e.g. Finance"></div>
                        <div><label>Fee %</label><input type="number" id="mgmtFeePct"></div>
                        <div><label>Min. Fee ($)</label><input type="number" id="mgmtMin" value="0"></div>
                    </div>

                    <div class="buildium-check-box" style="margin-top:15px;">
                        <label style="color:#003366;"><strong>Rent Scenario (Select One):</strong></label>
                        <div style="margin-top:5px; display:flex; gap:15px; flex-wrap:wrap;">
                            <label><input type="radio" name="mgmtRentCheck" value="no" checked onchange="toggleMgmtRent('no')"> Constant Rent</label>
                            <label><input type="radio" name="mgmtRentCheck" value="yes" onchange="toggleMgmtRent('yes')"> Rent Changed (Same Tenant)</label>
                            <label><input type="radio" name="mgmtRentCheck" value="turnover" onchange="toggleMgmtRent('turnover')"> Turnover (Different Tenants)</label>
                        </div>

                        <div id="mgmtRentSingle" style="margin-top:10px;"><label>Current Rent ($)</label><input type="number" id="mgmtRentA"></div>

                        <div id="mgmtRentMulti" style="display:none; margin-top:10px; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                            <div><label>Old Rent</label><input type="number" id="mgmtRentOld"></div>
                            <div><label>New Rent</label><input type="number" id="mgmtRentNew"></div>
                            <div>
                                <label>Change Month</label>
                                <select id="mgmtChangeMonth">
                                    <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                                    <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                                    <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                                </select>
                            </div>
                        </div>

                        <div id="mgmtRentTurnover" style="display:none; margin-top:10px; background:#fff3e0; padding:10px; border-radius:4px; border:1px solid #ffcc80;">
                            <p style="font-size:0.8rem; margin:0 0 5px 0; color:#e65100;"><strong>Turnover Logic:</strong> Enter rent for Tenant A and Tenant B. Gap months (vacancy) will assume $0 rent unless min fee applies.</p>
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
                                <div><label>Tenant A Rent</label><input type="number" id="turnRentA" placeholder="$"></div>
                                <div><label>End Month</label>
                                    <select id="turnEndMonth">
                                        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                                    </select>
                                </div>
                                <div><label>Tenant B Rent</label><input type="number" id="turnRentB" placeholder="$"></div>
                                <div><label>Start Month</label>
                                    <select id="turnStartMonth">
                                        <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="drop-zone" onclick="document.getElementById('mgmtAgreementFile').click()"><div><strong>Mgmt Agreement (PDF)</strong></div><input type="file" id="mgmtAgreementFile" accept=".pdf" style="display:none" onchange="processFile(this, 'mgmtPdf')"><div id="mgmtPdfStatus" style="color:var(--accent);"></div></div>
                        <div class="drop-zone" onclick="document.getElementById('mgmtStmtFile').click()"><div><strong>Owner Statement (CSV)</strong></div><input type="file" id="mgmtStmtFile" accept=".csv" style="display:none" onchange="processFile(this, 'mgmtCsv')"><div id="mgmtCsvStatus" style="color:var(--accent);"></div></div>
                    </div>
                    <button class="btn btn-accent" style="margin-top:20px; width:100%;" onclick="runMgmtAudit()">üöÄ Verify Fees (Greater Of Logic)</button>
                </div>
            </div>

            <div class="card" id="resultsCard" style="display:none;">
                <h3>3. Audit Results</h3>
                <div id="finResultBox"></div>
                <div id="opsWorkflow" class="stagnation-box" style="display:none; margin-top:15px;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Alert: Rent Stagnation</h4>
                    <p>Notify Operations Manager.</p>
                    <textarea id="opsCommentTemplate" rows="4" style="width:100%;"></textarea>
                    <input type="text" id="opsTaskProof" placeholder="Task #">
                </div>
                <div style="margin-top:20px;">
                    <label><strong>Full Audit Report</strong></label>
                    <textarea id="fullReportOutput" rows="20" style="width:100%; padding:10px; font-family:monospace; background:#f4f4f4; border:1px solid #ddd;"></textarea>
                </div>
                <br>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="copyFullReport()"><i class="fas fa-copy"></i> Copy Report</button>
                    <button class="btn btn-accent" id="btnSave" onclick="saveAudit()">Save to Log</button>
                </div>
            </div>
        </div>

        <div id="historyTab" style="display:none;">
            <h2>Audit Log</h2>
            <div class="card">
                <table id="historyTable" style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#eee; text-align:left;">
                        <th style="padding:10px;">Date</th><th>Auditor</th><th>Type</th><th>Property</th><th>Result</th><th>Penalty</th><th>Ops Status</th><th>Assignee Status</th><th>Tools</th>
                    </tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIG & SETUP ---
const firebaseConfig = { apiKey: "AIzaSyAHDlSQ_mpC-m_OMwhuJToCeRk9MnRNf08", authDomain: "propertywize-qc-hub.firebaseapp.com", projectId: "propertywize-qc-hub", storageBucket: "propertywize-qc-hub.firebasestorage.app", messagingSenderId: "1056520755896", appId: "1:1056520755896:web:c088548af03fd03323f24d" };
let db = null, isConnected = false;
try { const app = firebase.initializeApp(firebaseConfig); db = firebase.firestore(); isConnected = true; } catch (e) { console.error("Firebase Error", e); }

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
let LEDGER_CSV = [], MGMT_CSV = [], PDF_TEXT = "";
let FILES = { csv: false, ledgerPdf: false, lease: false, mgmtCsv: false, mgmtPdf: false };
let CURRENT_AUDIT = {}, AUDIT_LOG = {}, QC_REF = "QC-" + Math.floor(100000 + Math.random() * 900000);
let LOGO_DATA = null, EDITING_ID = null, ACTION_TYPE = "";
let IS_RERUN_MODE = false;

function initApp() {
    const localData = localStorage.getItem('pw_qc_history');
    if (localData) {
        AUDIT_LOG = JSON.parse(localData);
        Object.keys(AUDIT_LOG).reverse().forEach(key => renderHistoryRow(key, false));
        updateScorecard();
    }
    if(localStorage.getItem('pw_qc_logo')) { 
        LOGO_DATA = localStorage.getItem('pw_qc_logo'); 
        document.getElementById('logoPreview').src=LOGO_DATA; 
        document.getElementById('logoPreview').style.display='block'; 
    }
    if(localStorage.getItem('pw_qc_auditor')) document.getElementById('globalAuditor').value = localStorage.getItem('pw_qc_auditor');
    document.getElementById('qcRefDisplay').innerText = QC_REF;

    if(isConnected) {
        document.getElementById('dbStatus').innerHTML = "üü¢ <strong>Connected (Syncing...)</strong>";
        document.getElementById('dbStatus').style.color = "green";
        db.collection("audits").onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const data = change.doc.data();
                AUDIT_LOG[data.qcRef] = data; 
                renderHistoryRow(data.qcRef, false); 
            });
            localStorage.setItem('pw_qc_history', JSON.stringify(AUDIT_LOG));
            updateScorecard();
            document.getElementById('dbStatus').innerHTML = "üü¢ <strong>Connected & Synced</strong>";
        });
    }
}

// --- FILE PROCESSOR (FIXED FOR UPLOADS) ---
function processFile(input, type) {
    if(input.files.length === 0) return;
    
    if(type === 'csv') {
        Papa.parse(input.files[0], { header: false, skipEmptyLines: true, complete: r => { LEDGER_CSV = r.data; document.getElementById('stmtStatus').innerText = "‚úÖ Loaded"; FILES.csv = true; }});
    } else if(type === 'mgmtCsv') {
        Papa.parse(input.files[0], { header: false, skipEmptyLines: true, complete: r => { MGMT_CSV = r.data; document.getElementById('mgmtCsvStatus').innerText = "‚úÖ Loaded"; FILES.mgmtCsv = true; }});
    } else if (type === 'mgmtPdf') {
        document.getElementById('mgmtPdfStatus').innerText = "‚úÖ Loaded"; 
        FILES.mgmtPdf = true; 
    } else if (type === 'ledgerPdf') {
        const fileReader = new FileReader();
        fileReader.onload = function() {
            const typedarray = new Uint8Array(this.result);
            pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                let fullText = ""; let count = 0;
                for(let i=1; i<=pdf.numPages; i++) {
                    pdf.getPage(i).then(page => page.getTextContent()).then(text => {
                        fullText += text.items.map(s => s.str).join(" ") + " ";
                        count++;
                        if(count === pdf.numPages) { PDF_TEXT = fullText; document.getElementById('pdfStatus').innerText = "‚úÖ Scanned"; FILES.ledgerPdf = true; }
                    });
                }
            });
        };
        fileReader.readAsArrayBuffer(input.files[0]);
    } else { 
        document.getElementById('leaseStatus').innerText = "‚úÖ Loaded"; 
        FILES.lease = true; 
    }
}

// --- TENANT LEDGER AUDIT (FIXED: DETAILED RENT LOG + CUSTOM SCHEDULE + WAIVED FEES) ---
function runLedgerAudit() {
    if(!FILES.csv) return alert("Upload Tenant Ledger CSV (Slot 1)");
    
    const rentMode = document.getElementById("rentChangeToggle").value; 
    const excludeHap = document.getElementById('excludeHap') ? document.getElementById('excludeHap').checked : false;

    let rJan, rDec, splitMonth, logicSummary;
    
    if(rentMode === 'no') {
        rJan = parseFloat(document.getElementById('rentConst').value);
        logicSummary = `METHODOLOGY: Verified Constant Rent ($${rJan}).`;
    } else if (rentMode === 'yes') {
        rJan = parseFloat(document.getElementById('rentOld').value);
        rDec = parseFloat(document.getElementById('rentNew').value);
        splitMonth = parseInt(document.getElementById('changeMonth').value);
        logicSummary = `METHODOLOGY: Verified Split Rent ($${rJan} -> $${rDec}).`;
    } else {
        logicSummary = `METHODOLOGY: Verified Custom/Multi-Change Schedule (Sec 8 Flux).`;
    }

    if(excludeHap) logicSummary += " [Scope: Tenant Portion Only (Excl HAP)]";
    if(rentMode !== 'multi' && isNaN(rJan)) return alert("Enter Rent Amount");

    let monthlyTotals = {}, errors = [], lateFeesChecked = 0;
    let detailedLog = "DETAILED VERIFICATION LOG:\nDate       | Type       | Chrg    | Exp.    | Status\n------------------------------------------------------\n";

    LEDGER_CSV.forEach(row => {
        let dateVal = null;
        let potentialDateA = row[0];  
        let potentialDateT = row[19]; 

        if (typeof potentialDateA === 'string' && potentialDateA.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
             let y = parseInt(potentialDateA.split('/')[2]);
             if (y < 2030) dateVal = potentialDateA;
        }
        if (!dateVal && typeof potentialDateT === 'string' && potentialDateT.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
             let y = parseInt(potentialDateT.split('/')[2]);
             if (y < 2030) dateVal = potentialDateT;
        }
        if(!dateVal) return;
        
        let rowStr = row.join("||").toLowerCase();
        let memo = (row[20] || "").toLowerCase();

        if (excludeHap && (rowStr.includes('hap') || rowStr.includes('sx8') || rowStr.includes('subsidy'))) return;

        let amt = 0;
        let valX = parseFloat((row[23]||"").toString().replace(/[$,]/g,''));
        if(!isNaN(valX) && valX !== 0) amt = valX;
        else { for(let c of row) { let v = parseFloat((c||"").toString().replace(/[$,]/g,'')); if(!isNaN(v) && v > 0 && v < 5000) amt = v; } }

        let desc = row[15] ? row[15].toLowerCase() : rowStr; 
        if(dateVal && amt > 0 && (desc.includes('rent') || desc.includes('sx8') || desc.includes('hap'))) {
            let d = new Date(dateVal); 
            if(!isNaN(d)) { 
                let k = d.getFullYear() + "-" + (d.getMonth()+1); 
                if(!monthlyTotals[k]) monthlyTotals[k] = { val:0, m: d.getMonth()+1 }; 
                monthlyTotals[k].val += amt; 
            }
        }

        const isNotUtility = !rowStr.includes('water') && !rowStr.includes('utility');

        if(rowStr.includes('late fee') && isNotUtility) {
            lateFeesChecked++;
            if(memo.includes('waive') || rowStr.includes('waived') || rowStr.includes('reversed')) {
                detailedLog += `${dateVal.padEnd(10)} | Late Fee   | $0.00   | WAIVED  | ‚úÖ PASS\n`;
                return;
            }

            let m = new Date(dateVal).getMonth() + 1;
            
            let currentRent = 0;
            if (rentMode === 'no') currentRent = rJan;
            else if (rentMode === 'yes') currentRent = (m < splitMonth) ? rJan : rDec;
            else {
                currentRent = parseFloat(document.getElementById('r'+m).value) || 0;
            }

            let expected = currentRent * 0.05;
            let isPass = Math.abs(amt - expected) <= 0.10;
            let statusIcon = isPass ? "‚úÖ PASS" : "‚ùå FAIL";
            
            detailedLog += `${dateVal.padEnd(10)} | Late Fee   | $${Math.round(amt).toString().padEnd(5)} | $${Math.round(expected).toString().padEnd(5)} | ${statusIcon}\n`;
            
            if(!isPass) errors.push(`Late Fee Mismatch ${dateVal}: Charged $${amt.toFixed(2)} | Expected 5% ($${expected.toFixed(2)})`);
        }
    });

    Object.keys(monthlyTotals).sort().forEach(k => {
        let item = monthlyTotals[k]; 
        let expected = 0;
        if (rentMode === 'no') expected = rJan;
        else if (rentMode === 'yes') expected = (item.m < splitMonth) ? rJan : rDec;
        else expected = parseFloat(document.getElementById('r'+item.m).value) || 0; 
        
        let status = "PASS";
        if(Math.abs(item.val - expected) > 1.0) { 
            status = "FAIL";
            errors.push(`Mismatch ${k}: Charged $${item.val.toFixed(2)} | Expected $${expected.toFixed(2)}`); 
        }
        let stIcon = status === 'PASS' ? "‚úÖ" : "‚ùå";
        detailedLog += `${k.padEnd(10)} | Rent       | $${item.val.toFixed(2).padEnd(6)} | $${expected.toFixed(2).padEnd(6)} | ${stIcon} ${status}\n`;
    });

    if(lateFeesChecked === 0) detailedLog += "NOTE: No 'Late Fee' line items found to audit.\n";

    if(FILES.ledgerPdf && PDF_TEXT) {
        detailedLog += `\nPDF ALLOCATION CHECK:\n`;
        const suspiciousKeys = ["Rent Court", "Legal", "Warrant"];
        let scanFail = false;
        let chunks = PDF_TEXT.split(/(\d{1,2}\/\d{1,2}\/\d{4})/); 
        for(let i=1; i<chunks.length; i+=2) {
            let dateStr = chunks[i];
            let content = chunks[i+1]; 
            if((content.includes("Payment") || content.includes("payment")) && content.includes("($")) {
                for(let key of suspiciousKeys) {
                    if(content.includes(key)) {
                        let amtMatch = content.match(/\(\$([0-9,]+\.[0-9]{2})\)/);
                        if(amtMatch && parseFloat(amtMatch[1].replace(/,/g,'')) > 200) {
                            errors.push(`FINANCE ERROR (${dateStr}): Payment ($${amtMatch[1]}) misallocated to '${key}' instead of Rent.`);
                            scanFail = true;
                            detailedLog += `${dateStr} | Misalloc   | ${key} | Rent    | ‚ùå FAIL\n`;
                        }
                    }
                }
            }
        }
        if(!scanFail) detailedLog += "Scanned for [Rent Court, Legal, Warrant] -> ‚úÖ No Misallocations Found.\n";
    }

    let status = errors.length === 0 ? "PASS" : "FAIL";
    let penalty = status === "FAIL" ? (errors.length * 5).toFixed(2) : "0.00";
    
    let report = `QC AUDIT REPORT [Ref: ${QC_REF}]\nDate: ${new Date().toLocaleDateString()}\nStatus: ${status}\nPenalty: $${penalty}\n\n${logicSummary}\n\n${detailedLog}\n------------------------------------------------\nSUMMARY FINDINGS:\n`;
    if(status === 'FAIL') {
        report += errors.map(e => `- ${e}`).join('\n');
        report += `\n\n------------------------------------------------\nNEXT STEPS:\nPlease review findings on QC Dashboard.\n1. ACKNOWLEDGE: If you agree, correct ledger and click "Acknowledge".\n2. APPEAL: If you disagree, click "Appeal".`;
    } else report += "- All audited items matched expected values.\n- No financial discrepancies found.";

    document.getElementById('fullReportOutput').value = report;
    document.getElementById('resultsCard').style.display = 'block';
    document.getElementById('finResultBox').innerHTML = status === 'PASS' ? `<div style="padding:10px; background:#d4edda; color:#155724;">‚úÖ Audit Passed</div>` : `<div style="padding:10px; background:#f8d7da; color:#721c24;">‚ùå Audit Failed</div>`;
    
    let isStagnant = false;
    let leaseStart = new Date(document.getElementById('leaseStartInput').value);
    if(leaseStart && new Date() - leaseStart > 31536000000) { 
        isStagnant = true; 
        document.getElementById('opsWorkflow').style.display='block';
        const opsNote = `Observation: Rent unchanged > 12 months.\nAction: Please advise on Rent Increase Strategy.\n\nOPTIONS:\n1. Owner elected to keep rent the same\n2. Managed < 12 months (Increase Scheduled)\n3. Missed requirement / MTM (Will submit increase)\n4. Other\n\n*Please respond to this request within 1 business day so the QC Auditor can clear the Rent Stagnation Flag.*`;
        document.getElementById('opsCommentTemplate').value = opsNote;
    }

    CURRENT_AUDIT = { qcRef: QC_REF, date: new Date().toISOString(), type: "Tenant Ledger Audit", prop: document.getElementById('propAddress').value, tenant: document.getElementById('scanTenant').value, task: document.getElementById('mainTaskNumber').value, assignee: document.getElementById('assignVA').value, auditor: document.getElementById('globalAuditor').value, status, penaltyAmt: parseFloat(penalty), report, isStagnant, opsStatus: isStagnant?'PENDING':'N/A', assigneeStatus: status==='FAIL' ? 'PENDING' : 'N/A' };
}

// --- MANAGEMENT AUDIT (FIXED: START DATE BUCKET + NO HEADER BUG + VACANCY/LEASING LOGIC + FUTURE DATE FIX) ---
function runMgmtAudit() {
    if(!FILES.mgmtCsv) return alert("Upload Owner Statement CSV (Slot 2)");
    
    const feePct = parseFloat(document.getElementById('mgmtFeePct').value) / 100;
    const minFee = parseFloat(document.getElementById('mgmtMin').value) || 0;
    const prop = document.getElementById('mgmtProp').value;
    const taskNum = document.getElementById('mgmtTaskNum').value; 
    const auditorName = document.getElementById('globalAuditor').value;
    
    // SAFE PROPERTY NUMBER EXTRACTION (Prevent "0" default bug)
    let propMatch = prop.match(/\d+/);
    let propNumber = propMatch ? propMatch[0] : "INVALID_PROP_NUM"; 

    const mode = document.querySelector('input[name="mgmtRentCheck"]:checked').value;
    
    let rJan, rDec, splitMonth;
    let turnRentA, turnEnd, turnRentB, turnStart;

    if (mode === 'no') {
        rJan = parseFloat(document.getElementById('mgmtRentA').value);
        if(isNaN(rJan)) return alert("Enter Rent Amount");
    } else if (mode === 'yes') {
        rJan = parseFloat(document.getElementById('mgmtRentOld').value);
        rDec = parseFloat(document.getElementById('mgmtRentNew').value);
        splitMonth = parseInt(document.getElementById('mgmtChangeMonth').value);
        if(isNaN(rJan)) return alert("Enter Old & New Rent");
    } else {
        turnRentA = parseFloat(document.getElementById('turnRentA').value);
        turnEnd = parseInt(document.getElementById('turnEndMonth').value);
        turnRentB = parseFloat(document.getElementById('turnRentB').value);
        turnStart = parseInt(document.getElementById('turnStartMonth').value);
        if(isNaN(turnRentA) || isNaN(turnRentB)) return alert("Enter Rent for both tenants");
    }

    if(isNaN(feePct)) return alert("Enter Management Fee %");

    let errors = [];
    let monthlyData = {}; 
    for(let i=1; i<=12; i++) monthlyData[i] = { found: false, actual: 0, date: null };

    // FIX: SORT CSV BY DATE CHRONOLOGICALLY (Skip Header if present)
    let cleanCsv = MGMT_CSV.filter(r => !isNaN(Date.parse(r[2]))); // Filter valid dates
    cleanCsv.sort((a,b) => new Date(a[2]) - new Date(b[2]));

    // DETECT AUDIT YEAR (Use most frequent year in CSV)
    let yearCounts = {};
    let latestCsvDate = new Date(0); 

    cleanCsv.forEach(row => {
        let d = new Date(row[2]);
        let y = d.getFullYear(); 
        yearCounts[y] = (yearCounts[y] || 0) + 1; 
        if(d > latestCsvDate) latestCsvDate = d;
    });
    
    // SAFE YEAR DETECTION (Defaults to current year if fails)
    let auditYear = new Date().getFullYear();
    if (Object.keys(yearCounts).length > 0) {
        auditYear = parseInt(Object.keys(yearCounts).reduce((a, b) => yearCounts[a] > yearCounts[b] ? a : b));
    }

    cleanCsv.forEach(row => {
        let rowStr = row.join(" ").toLowerCase();
        
        // FIX: BLOCK LEASING/PLACEMENT FEES
        if((rowStr.includes("management fees") || rowStr.includes("management fee")) && !rowStr.includes("leasing") && !rowStr.includes("placement") && !rowStr.includes("finder") && !rowStr.includes("marketing") && !rowStr.includes("letting") && !rowStr.includes("commission")) {
            
            let dateVal = row[2]; // Default Date (Col C)
            let d = new Date(dateVal);

            // FIX: SMART DATE LOGIC (Use START Date for Month Bucket)
            // Example: 1/11/2025 - 2/10/2025 -> Jan 11 -> January
            let rangeMatch = rowStr.match(/(\d{1,2}\/\d{1,2}\/\d{2,4})\s*-\s*(\d{1,2}\/\d{1,2}\/\d{2,4})/);
            
            if (rangeMatch) {
                d = new Date(rangeMatch[1]); // Use START Date
            } 
            
            // STRICT YEAR CHECK
            if (d.getFullYear() !== auditYear) return;

            if(!isNaN(d)) {
                let m = d.getMonth() + 1;
                monthlyData[m].found = true;
                
                let rawVal = (row[13] || "").toString().replace(/[$,]/g,'');
                
                // ANTI-ADDRESS LOGIC
                if (rawVal.includes(propNumber) || /[a-zA-Z]/.test(rawVal)) {
                    // Skip bad val
                } else {
                    let valN = parseFloat(rawVal); 
                    // SAFETY CAP
                    let safeCap = Math.max(turnRentA || 0, turnRentB || 0, rJan || 0, rDec || 0) * 1.5; 
                    if(safeCap === 0) safeCap = 5000; 

                    if(!isNaN(valN) && valN !== 0 && Math.abs(valN) < safeCap) {
                        monthlyData[m].actual += Math.abs(valN);
                    }
                }
            }
        }
    });

    let reportRows = "";
    
    // BUILD REPORT (Iterate 1-12)
    for(let m=1; m<=12; m++) {
        let currentRent = 0;
        let isTransitionMonth = false;

        if (mode === 'no') currentRent = rJan;
        else if (mode === 'yes') currentRent = (m >= splitMonth) ? rDec : rJan;
        else {
            if (m === turnEnd || m === turnStart) isTransitionMonth = true; 
            if (m <= turnEnd) currentRent = turnRentA;      
            else if (m >= turnStart) currentRent = turnRentB; 
            else currentRent = 0; // Vacancy
        }

        let calcFee = currentRent * feePct;
        let expectedFee = Math.max(calcFee, minFee);
        
        // FIX: VACANCY LOGIC
        if (currentRent === 0) expectedFee = 0;

        let actualFee = monthlyData[m].actual;
        let status = "PASS";
        let note = "";
        
        let thisMonthDate = new Date(auditYear, m-1, 28); 
        let isFuture = thisMonthDate > latestCsvDate;

        if (isFuture && actualFee === 0) {
             status = "PENDING";
             note = "(No Data)";
        } 
        else if(Math.abs(actualFee - expectedFee) > 0.05) {
            if (mode === 'turnover' && isTransitionMonth && actualFee > 0 && actualFee < expectedFee) {
                status = "PASS";
                note = "(Prorated)";
            } else {
                status = "FAIL";
                errors.push(`Month ${m}: Charged $${actualFee.toFixed(2)}, Expected $${expectedFee.toFixed(2)}`);
            }
        }

        let monthName = new Date(auditYear, m-1, 1).toLocaleString('default', { month: 'short' });
        let stIcon = status === 'PASS' ? "‚úÖ" : (status === 'PENDING' ? "‚è≥" : "‚ùå");
        reportRows += `${monthName.padEnd(12)}| $${currentRent.toFixed(2).padEnd(8)}| $${expectedFee.toFixed(2).padEnd(8)}| $${actualFee.toFixed(2).padEnd(8)}| ${stIcon} ${status} ${note}\n`;
    }

    let status = errors.length === 0 ? "PASS" : "FAIL";
    let penalty = status === 'FAIL' ? (errors.length * 5).toFixed(2) : "0.00";

    let logicDesc = (mode === 'turnover') 
        ? `Turnover: Tenant A ($${turnRentA}) -> Vacancy -> Tenant B ($${turnRentB})`
        : `Greater Of Rule (${(feePct*100).toFixed(1)}% vs $${minFee})`;

    let fullReport = `QC AUDIT REPORT [Ref: ${QC_REF}]\nDate: ${new Date().toLocaleDateString()}\nType: Management Fee Audit\nProperty: ${prop}\nBuildium Task #: ${taskNum || "N/A"}\n\nMETHODOLOGY: ${logicDesc}.\n\nSTATUS: ${status}\nPENALTY: $${penalty}\nFindings:\n`;
    
    if(status === 'FAIL') {
        fullReport += errors.join('\n') + "\n\n";
        fullReport += `------------------------------------------------\nNEXT STEPS:\nPlease review findings on QC Dashboard.\n1. ACKNOWLEDGE: If you agree, correct ledger and click "Acknowledge".\n2. APPEAL: If you disagree, click "Appeal".\n`;
    } else fullReport += "‚úÖ All fees matched agreement.\n\n";

    fullReport += `DETAILED LOG:\nMonth       | Rent Base | Expected | Charged  | Status\n----------------------------------------------------\n`;
    fullReport += reportRows;

    document.getElementById('fullReportOutput').value = fullReport;
    document.getElementById('resultsCard').style.display = 'block';
    document.getElementById('finResultBox').innerHTML = status === "PASS" ? 
        `<div style="padding:15px; background:#d4edda; color:#155724;"><h3>‚úÖ Audit Passed</h3></div>` : 
        `<div style="padding:15px; background:#f8d7da; color:#721c24;"><h3>‚ùå Audit Failed</h3><p>${errors.length} Errors Found (Penalty: $${penalty})</p></div>`;

    let assignStatus = status === 'FAIL' ? 'PENDING' : 'N/A';
    CURRENT_AUDIT = { qcRef: QC_REF, date: new Date().toISOString(), type: "Management Fee Audit", prop, task: taskNum, auditor: auditorName, status, errors, report: fullReport, penaltyAmt: parseFloat(penalty), isStagnant: false, opsStatus: 'N/A', assigneeStatus: assignStatus };
}

// --- WORKFLOW: SAVE & RE-RUN ---
function saveAudit() {
    if (CURRENT_AUDIT.type === "Management Fee Audit") {
        const liveTaskNum = document.getElementById('mgmtTaskNum').value;
        if(liveTaskNum) CURRENT_AUDIT.task = liveTaskNum; 
    }

    if(CURRENT_AUDIT.type === "Management Fee Audit" && CURRENT_AUDIT.status === "FAIL" && !CURRENT_AUDIT.task) {
        return alert("‚ö†Ô∏è Compliance Check:\nPlease enter the Buildium Task # in the Management Audit Intake section before saving a failed audit.");
    }

    if (IS_RERUN_MODE) alert(`Audit Updated! (Ref: ${QC_REF})`);
    else alert("New Audit Saved!");

    if(isConnected) db.collection("audits").doc(QC_REF).set(CURRENT_AUDIT);
    AUDIT_LOG[QC_REF] = CURRENT_AUDIT;
    localStorage.setItem('pw_qc_history', JSON.stringify(AUDIT_LOG));
    
    renderHistoryRow(QC_REF, !IS_RERUN_MODE);
    updateScorecard();
    IS_RERUN_MODE = false;
    showTab('historyTab');
}

function loadAuditForRerun(id) {
    const data = AUDIT_LOG[id];
    if(!data) return alert("Audit not found");
    if(!confirm(`Re-run Audit ${id}?`)) return;

    showTab('auditTab');
    IS_RERUN_MODE = true;
    QC_REF = data.qcRef;
    document.getElementById('qcRefDisplay').innerText = QC_REF + " (RE-RUN)";
    document.getElementById('qcRefDisplay').style.color = "blue";

    document.getElementById('scanTenant').value = data.tenant || "";
    document.getElementById('propAddress').value = data.prop || "";
    document.getElementById('mainTaskNumber').value = data.task || "";
    document.getElementById('assignVA').value = data.assignee || "";
    
    document.getElementById('resultsCard').style.display = 'none';
    document.getElementById('btnSave').innerText = "Update Existing Log";
    alert("Data Loaded. Please re-upload documents and click 'Run'.");
}

function genPDF(id) {
    const data = AUDIT_LOG[id];
    if(!data) return alert("Error: Audit data not found.");

    document.getElementById('pdf-gen-date').innerText = (data.date || "").split('T')[0];
    document.getElementById('pdf-qc-ref').innerText = data.qcRef || "-";
    document.getElementById('pdf-header-status').innerText = data.status || "-";
    document.getElementById('pdf-type').innerText = data.type || "Audit";
    document.getElementById('pdf-auditor').innerText = data.auditor || "-";
    document.getElementById('pdf-assignee').innerText = data.assignee || "-";
    document.getElementById('pdf-task').innerText = data.task || "-";
    document.getElementById('pdf-tenant').innerText = data.tenant || "-";
    document.getElementById('pdf-property').innerText = data.prop || "-";
    
    if (data.report) {
        document.getElementById('pdf-content').innerHTML = data.report.replace(/\n/g, '<br>');
    } else {
        document.getElementById('pdf-content').innerText = "No detail available.";
    }
    
    const ops = document.getElementById('pdf-ops-section');
    if(data.isStagnant && data.opsStatus === "CLEARED" && data.resolution) {
        ops.style.display = 'block';
        document.getElementById('pdf-ops-status').innerText = "CLEARED";
        document.getElementById('pdf-ops-reason').innerText = data.resolution.reason || "N/A";
        document.getElementById('pdf-ops-ref').innerText = data.resolution.refId || "N/A";
        document.getElementById('pdf-ops-notes').innerText = data.resolution.notes || ""; 
    } else { 
        ops.style.display = 'none'; 
    }

    const img = document.getElementById('pdfLogo'); 
    if(LOGO_DATA) { img.src = LOGO_DATA; img.style.display = 'block'; }
    
    const el = document.getElementById('pdf-template');
    el.style.display = 'block';
    
    const opt = {
        margin: 0.25,
        filename: `Audit_${data.qcRef}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(el).save().then(() => {
        el.style.display = 'none';
    }).catch(err => {
        console.error(err);
        alert("PDF Error. See console.");
        el.style.display = 'none';
    });
}

function renderHistoryRow(id, isNew) {
    let data = AUDIT_LOG[id];
    let opsBadge = data.isStagnant ? (data.opsStatus === "CLEARED" ? '<span class="badge bg-pass">CLEARED</span>' : `<button class="status-action" onclick="openUpdateModal('${id}')">ACTION REQ</button>`) : '<span class="badge">N/A</span>';
    
    let assigneeBtn = '';
    if(data.assigneeStatus === 'PENDING') {
        assigneeBtn = `<button class="btn btn-outline" style="padding:2px 5px; font-size:0.7rem;" onclick="openActionModal('appeal', '${id}')">Appeal</button> <button class="btn btn-primary" style="padding:2px 5px; font-size:0.7rem;" onclick="openActionModal('ack', '${id}')">Ack</button>`;
    } else if (data.assigneeStatus === 'APPEALED') {
        assigneeBtn = `<span class="badge bg-warn">APPEALED</span>`;
    } else if (data.assigneeStatus === 'ACKNOWLEDGED') {
        assigneeBtn = `<span class="badge bg-blue">READY FOR RE-RUN</span>`;
    } else { assigneeBtn = '<span class="badge" style="background:#eee;">N/A</span>'; }

    let tools = `<button class="btn btn-outline" style="padding:2px 5px;" title="PDF" onclick="genPDF('${id}')"><i class="fas fa-file-pdf"></i></button> `;
    tools += `<button class="btn btn-primary" style="padding:2px 5px;" title="Re-Run" onclick="loadAuditForRerun('${id}')"><i class="fas fa-sync"></i></button> `;
    tools += `<button class="btn btn-danger" style="padding:2px 5px;" title="Delete" onclick="deleteAudit('${id}')"><i class="fas fa-trash"></i></button>`;

    let statusIcon = data.status==='PASS' ? (data.isStagnant ? '‚úÖ <i class="fas fa-exclamation-triangle icon-warning"></i>' : '‚úÖ') : '‚ùå';
    let html = `<td>${data.date.split('T')[0]}</td><td>${data.auditor||'-'}</td><td>${data.type||'-'}</td><td>${data.prop||'-'}</td><td>${statusIcon} ${data.status}</td><td>$${data.penaltyAmt}</td><td>${opsBadge}</td><td>${assigneeBtn}</td><td>${tools}</td>`;
    
    if(isNew) { let r = document.getElementById('historyBody').insertRow(0); r.id=`row-${id}`; r.innerHTML=html; }
    else { let r = document.getElementById(`row-${id}`); if(r) r.innerHTML=html; else { let nr = document.getElementById('historyBody').insertRow(-1); nr.id=`row-${id}`; nr.innerHTML=html; } }
}

// GENERIC UTILS
function toggleRentChange() { let v = document.getElementById("rentChangeToggle").value; document.getElementById('logicConstant').style.display = v==='no'?'block':'none'; document.getElementById('logicChanged').style.display = v==='yes'?'grid':'none'; document.getElementById('logicCustom').style.display = v==='multi'?'block':'none'; }
function toggleAuditMode() { let m = document.getElementById('auditTypeSelect').value; document.getElementById('ledgerAuditSection').style.display=m==='ledger'?'block':'none'; document.getElementById('mgmtAuditSection').style.display=m==='mgmt'?'block':'none'; document.getElementById('resultsCard').style.display='none'; }
function toggleMgmtRent(val) { 
    document.getElementById('mgmtRentSingle').style.display = val==='no'?'block':'none'; 
    document.getElementById('mgmtRentMulti').style.display = val==='yes'?'grid':'none'; 
    document.getElementById('mgmtRentTurnover').style.display = val==='turnover'?'block':'none'; 
}
function openUpdateModal(id) { EDITING_ID = id; document.getElementById('updateModal').style.display='flex'; }
function closeModal() { document.getElementById('updateModal').style.display='none'; document.getElementById('actionModal').style.display='none'; }
function confirmUpdate() { 
    if(AUDIT_LOG[EDITING_ID]) { 
        AUDIT_LOG[EDITING_ID].opsStatus = 'CLEARED'; 
        const reason = document.getElementById('modalOpsReason').value;
        const ref = document.getElementById('modalRefId').value;
        const notes = document.getElementById('modalNotes').value;
        if(reason && ref) AUDIT_LOG[EDITING_ID].resolution = { reason, refId: ref, notes: notes };
        if(isConnected) db.collection("audits").doc(EDITING_ID).update({ opsStatus: 'CLEARED', resolution: AUDIT_LOG[EDITING_ID].resolution });
        renderHistoryRow(EDITING_ID, false); 
    } 
    closeModal(); 
}
function openActionModal(type, id) {
    EDITING_ID = id; ACTION_TYPE = type;
    document.getElementById('modalTitle').innerText = type === 'appeal' ? 'Formal Appeal' : 'Acknowledge Findings';
    document.getElementById('actionModal').style.display = 'flex';
}
function confirmAction() {
    if(AUDIT_LOG[EDITING_ID]) {
        AUDIT_LOG[EDITING_ID].assigneeStatus = ACTION_TYPE === 'appeal' ? 'APPEALED' : 'ACKNOWLEDGED';
        if(isConnected) db.collection("audits").doc(EDITING_ID).update({ assigneeStatus: AUDIT_LOG[EDITING_ID].assigneeStatus });
        renderHistoryRow(EDITING_ID, false);
    }
    closeModal();
}
function deleteAudit(id) { if(confirm("Delete?")) { delete AUDIT_LOG[id]; localStorage.setItem('pw_qc_history', JSON.stringify(AUDIT_LOG)); document.getElementById(`row-${id}`).remove(); updateScorecard(); if(isConnected) db.collection("audits").doc(id).delete(); } }
function copyFullReport() { navigator.clipboard.writeText(document.getElementById('fullReportOutput').value); alert("Copied!"); }
function copyTatEmail() { navigator.clipboard.writeText(document.getElementById('tatEmailTemplate').value); alert("Copied!"); }
function showTab(id) { ['auditTab','historyTab','scoreTab'].forEach(t => document.getElementById(t).style.display = t===id?'block':'none'); }
function clearSystemData() { localStorage.clear(); location.reload(); }
function saveAuditorName() { localStorage.setItem('pw_qc_auditor', document.getElementById('globalAuditor').value); }
function loadLogo(input) { if(input.files && input.files[0]) { var r = new FileReader(); r.onload = function(e) { LOGO_DATA = e.target.result; localStorage.setItem('pw_qc_logo', LOGO_DATA); document.getElementById('logoPreview').src=LOGO_DATA; document.getElementById('logoPreview').style.display='block'; }; r.readAsDataURL(input.files[0]); } }
function updateScorecard() { 
    const audits = Object.values(AUDIT_LOG); 
    const total = audits.length; 
    const passed = audits.filter(a => a.status === 'PASS').length; 
    const rate = total === 0 ? 0 : Math.round((passed / total) * 100); 
    const penalties = audits.reduce((sum, a) => sum + (a.penaltyAmt || 0), 0); 
    document.getElementById('scoreTotal').innerText = total; 
    document.getElementById('scorePass').innerText = rate + "%"; 
    document.getElementById('scorePenalty').innerText = "$" + penalties.toFixed(2);
}
function checkTAT() { /* TAT Logic */ }
</script>
</body>
</html>
