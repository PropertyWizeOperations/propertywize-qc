<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PropertyWize QC Hub V20 (Smart Ledger)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root { --primary: #003366; --accent: #28a745; --danger: #dc3545; --warning: #ffc107; --light: #f4f6f9; }
body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
.navbar { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
.brand { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px; }
.brand span { color: white; }
.brand img { height: 40px; background: white; padding: 2px; border-radius: 4px; }
.mode-select { padding: 8px; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; }
.role-switch { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 20px; display: flex; gap: 10px; }
.role-btn { padding: 5px 15px; border-radius: 15px; cursor: pointer; border:none; opacity: 0.7; color: #333; background: #ddd; font-weight:bold; }
.role-btn.active { background: var(--accent); color: white; opacity: 1; }
.container { display: flex; flex: 1; overflow: hidden; }
.sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
.main-content { flex: 1; padding: 30px; overflow-y: auto; }
.nav-item { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: 500; }
.nav-item.active { background: #e8f5e9; color: var(--primary); border-left: 4px solid var(--accent); }
.card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
.drop-zone { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
.drop-zone:hover { border-color: var(--accent); background: #eef9f0; }
.scanned-data { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-top: 15px; background: #eef2f7; padding: 15px; border-radius: 6px; }
input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
.btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; margin-right: 5px; }
.btn-primary { background: var(--primary); color: white; }
.btn-accent { background: var(--accent); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-outline { border: 1px solid #ccc; background: white; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
th { background: #eef2f7; color: var(--primary); padding: 12px; text-align: left; }
td { padding: 10px 12px; border-bottom: 1px solid #eee; }
.badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
.bg-pass { background: #d4edda; color: #155724; } .bg-fail { background: #f8d7da; color: #721c24; }
.bg-warn { background: #fff3cd; color: #856404; }
#loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; justify-content:center; align-items:center; z-index:1000; flex-direction:column; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* PDF Styles */
#pdf-template { display: none; width: 800px; padding: 40px; font-family: 'Helvetica', sans-serif; background:white; color:#333; }
.pdf-header { display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #003366; padding-bottom:15px; margin-bottom:20px; }
.pdf-logo { font-size: 24px; font-weight: bold; color: #003366; }
.pdf-meta { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 30px; background: #f4f6f9; padding:15px; border-radius:5px; }
.pdf-status-box { text-align:center; padding: 20px; border-radius: 8px; margin-bottom: 30px; font-size: 20px; font-weight:bold; }
.pdf-pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.pdf-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div><div style="margin-top:10px; font-weight:bold; color:var(--primary);">Processing...</div></div>

<div id="pdf-template">
<div class="pdf-header">
<div class="pdf-logo">PropertyWize QC Hub</div>
<div class="pdf-title">Official Audit Report</div>
</div>
<div class="pdf-meta">
<div><strong>Date:</strong> <span id="pdf-date"></span></div>
<div><strong>Type:</strong> <span id="pdf-type"></span></div>
<div><strong>Subject:</strong> <span id="pdf-subject"></span></div>
<div><strong>Auditor:</strong> <span id="pdf-auditor"></span></div>
</div>
<div id="pdf-status" class="pdf-status-box"></div>
<h3>Detailed Findings</h3>
<div id="pdf-content" style="line-height: 1.6;"></div>
<div style="margin-top:50px; border-top:1px solid #ccc; padding-top:10px; font-size:0.8rem; color:#777;">
Verified by PropertyWize QC System | Generated automatically.
</div>
</div>

<div class="navbar">
<div class="brand"><img src="small logo.jpg" alt="PW" onerror="this.style.display='none'"> PropertyWize QC Hub</div>
<div>
<select id="auditTypeSelect" class="mode-select" onchange="toggleAuditMode()">
<option value="ledger">Tenant Ledger Audit</option>
<option value="mgmt">Management Fee Audit</option>
</select>
</div>
<div class="role-switch">
<button class="role-btn active" id="btnManager" onclick="setRole('Manager')">Manager</button>
<button class="role-btn" id="btnVA" onclick="setRole('VA')">Staff</button>
</div>
</div>

<div class="container">
<div class="sidebar">
<div class="nav-item active" id="navAudit" onclick="showTab('auditTab')"><i class="fas fa-magic"></i> New Audit</div>
<div class="nav-item" onclick="showTab('historyTab')"><i class="fas fa-history"></i> Audit Log</div>
<div class="nav-item" id="navScore" onclick="showTab('scorecardTab')"><i class="fas fa-chart-line"></i> Scorecard</div>
</div>

<div class="main-content">
<div id="auditTab">
<div id="ledgerAuditSection">
<h2><i class="fas fa-file-invoice"></i> Tenant Ledger Audit</h2>
<div class="card">
<h3>1. Upload Documents</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div class="drop-zone" onclick="document.getElementById('leaseFile').click()">
<i class="fas fa-file-contract fa-2x"></i> <div>Lease Agreement (PDF)</div>
<input type="file" id="leaseFile" accept=".pdf" style="display:none" onchange="processLease(this)">
<div id="leaseStatus" class="file-status" style="color:var(--accent)"></div>
</div>
<div class="drop-zone" onclick="document.getElementById('ledgerFile').click()">
<i class="fas fa-table fa-2x"></i> <div>Tenant Ledger (PDF)</div>
<input type="file" id="ledgerFile" accept=".pdf" style="display:none" onchange="processLedger(this)">
<div id="ledgerStatus" class="file-status" style="color:var(--accent)"></div>
</div>
</div>
</div>
<div class="card" id="verificationCard" style="display:none;">
<h3>2. Verify Data (Smart Rent Logic)</h3>
<div class="scanned-data">
<div><label>Assign To</label><input type="text" id="assignVA" placeholder="VA Name..."></div>
<div><label>Tenant</label><input type="text" id="scanTenant"></div>
<div><label>Address</label><input type="text" id="scanAddress"></div>
</div>

<div class="scanned-data" style="margin-top:10px; background:#e3f2fd; border:1px solid #90caf9;">
<div>
<label>Base Rent (Jan/Old)</label>
<input type="number" id="rentLedgerJan" placeholder="Old Rent Amount">
</div>
<div style="display:flex; align-items:center; justify-content:center; color:#003366; font-weight:bold;">
<i class="fas fa-arrow-right"></i> Fill both if rent increased <i class="fas fa-arrow-left"></i>
</div>
<div>
<label>Base Rent (Dec/New)</label>
<input type="number" id="rentLedgerDec" placeholder="New Rent Amount">
</div>
</div>

<button class="btn btn-accent" style="margin-top:15px; width:100%;" onclick="runAuditLogic()">üöÄ Run Smart Financial Audit</button>
</div>
</div>

<div id="mgmtAuditSection" style="display:none;">
<h2><i class="fas fa-building"></i> Management Fee Audit</h2>
<div class="card">
<h3>1. Upload Documents</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div class="drop-zone" onclick="document.getElementById('pmAgreementFile').click()">
<i class="fas fa-handshake fa-2x"></i> <div>PM Agreement (PDF)</div>
<input type="file" id="pmAgreementFile" accept=".pdf" style="display:none" onchange="processPMAgreement(this)">
<div id="pmStatus" class="file-status" style="color:var(--accent)"></div>
</div>
<div class="drop-zone" onclick="document.getElementById('ownerStmtFile').click()">
<i class="fas fa-chart-bar fa-2x"></i> <div>Owner Statement (CSV)</div>
<input type="file" id="ownerStmtFile" accept=".csv" style="display:none" onchange="processOwnerStmt(this)">
<div id="stmtStatus" class="file-status" style="color:var(--accent)"></div>
</div>
</div>
</div>

<div class="card" id="mgmtVerifyCard">
<h3>2. Fee & Lease Parameters</h3>
<div class="scanned-data" style="grid-template-columns: 1fr 1fr 1fr;">
<div>
<label>Property Name</label>
<input type="text" id="mgmtPropName" placeholder="Auto-detected from CSV...">
</div>
<div>
<label>Mgmt Fee %</label>
<input type="number" id="mgmtFeePct" placeholder="e.g. 10" value="10">
</div>
<div>
<label>Assign To (VA)</label>
<input type="text" id="assignVAMgmt" placeholder="VA Name...">
</div>
</div>

<div class="scanned-data" style="margin-top:10px; background:#fff3e0; border:1px solid #ffe0b2;">
<div>
<label>Current Lease Start</label>
<input type="date" id="leaseStart">
</div>
<div>
<label>Current Lease End</label>
<input type="date" id="leaseEnd">
</div>
<div style="display:flex; align-items:center;">
<input type="checkbox" id="monthToMonth" style="width:20px; margin-right:5px;"> <label>Month to Month / Ongoing</label>
</div>
</div>

<div class="scanned-data" style="margin-top:10px; background:#e3f2fd; border:1px solid #90caf9;">
<div>
<label>Rent Amount (Jan/Old)</label>
<input type="number" id="rentJan" placeholder="Start of Year Rent">
</div>
<div>
<label>Rent Amount (Dec/New)</label>
<input type="number" id="rentDec" placeholder="End of Year Rent">
</div>
<div style="display:flex; align-items:center; color:#555; font-size:0.8rem;">
*Enter both if rent changed mid-year
</div>
</div>
<button class="btn btn-accent" style="margin-top:15px; width:100%;" onclick="runMgmtAudit()">üöÄ Run Smart Audit (Duplicates + Vacancy Check)</button>
</div>
</div>

<div class="card" id="resultsCard" style="display:none;">
<h3>3. Audit Results</h3>
<div id="auditReport"></div>
<div style="margin-top:15px;">
<label><strong>Correction Email Template</strong></label>
<textarea id="emailOutput" rows="12" style="width:100%; padding:10px; font-family:monospace; background:#f4f4f4; border:1px solid #ddd;"></textarea>
</div>
<br>
<div style="display:flex; gap:10px;">
<button class="btn btn-primary" onclick="sendEmailApp()"><i class="fas fa-envelope"></i> Open Email App</button>
<button class="btn btn-outline" onclick="copyEmail()">Copy Text</button>
<button class="btn btn-accent" onclick="saveAudit()" style="margin-left:auto;">Save & Assign</button>
</div>
</div>
</div>

<div id="historyTab" style="display:none;">
<h2>Audit Log</h2>
<div class="card">
<table id="historyTable">
<thead><tr><th>Date</th><th>Type</th><th>Property / Tenant</th><th>Assigned</th><th>Status</th><th>Actions</th></tr></thead>
<tbody id="historyBody"></tbody>
</table>
</div>
</div>

<div id="scorecardTab" style="display:none;">
<h2>Performance Scorecard</h2>
<div class="card">
<div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; text-align:center;">
<div style="padding:20px; background:#eef2f7; border-radius:8px;"><h1 style="color:var(--primary); margin:0;" id="totalAudits">0</h1><span>Total Audits</span></div>
<div style="padding:20px; background:#eef2f7; border-radius:8px;"><h1 style="color:var(--accent); margin:0;" id="avgScore">100%</h1><span>Avg Accuracy</span></div>
<div style="padding:20px; background:#eef2f7; border-radius:8px;"><h1 style="color:var(--danger); margin:0;" id="totalPenalty">$0</h1><span>Total Penalties</span></div>
</div>
</div>
</div>
</div>
</div>

<script>
// --- SETUP ---
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
let CURRENT_ROLE = 'Manager';
let EXTRACTED_LEDGER = [];
let OWNER_STMT_DATA = [];
let CURRENT_AUDIT_MODE = 'ledger';
let LAST_AUDIT_DATA = {};
let AUDIT_HISTORY = {};
let AUDIT_COUNTER = 0;

function toggleAuditMode() {
const mode = document.getElementById('auditTypeSelect').value;
CURRENT_AUDIT_MODE = mode;
document.getElementById('ledgerAuditSection').style.display = mode === 'ledger' ? 'block' : 'none';
document.getElementById('mgmtAuditSection').style.display = mode === 'mgmt' ? 'block' : 'none';
document.getElementById('resultsCard').style.display = 'none';
}

function setRole(role) {
CURRENT_ROLE = role;
document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
document.getElementById('btn' + (role === 'VA' ? 'VA' : 'Manager')).classList.add('active');
document.getElementById('navAudit').style.display = role === 'Manager' ? 'block' : 'none';
document.getElementById('navScore').style.display = role === 'Manager' ? 'block' : 'none';
if(role === 'VA') showTab('historyTab'); else renderHistory();
}

function showTab(id) {
document.querySelectorAll('.main-content > div').forEach(d => d.style.display = 'none');
document.getElementById(id).style.display = 'block';
if(id === 'historyTab') renderHistory();
}

// --- PARSING & UPLOADS ---
async function extractText(file, limit=0) {
const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
let text = "";
const max = limit || pdf.numPages;
for(let i=1; i<=max; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" ") + "\n";
return text;
}

async function processLease(input) {
document.getElementById('loadingOverlay').style.display = 'flex';
try {
const text = await extractText(input.files[0], 2);
document.getElementById('leaseStatus').innerText = "‚úÖ Ready";
const rentMatch = text.match(/installments of[\s\S]{1,150}?\$([0-9,]+\.[0-9]{2})/i);
const nameMatch = text.match(/Name:\s*([A-Za-z]+\s+[A-Za-z]+).*?DOB:/);
const addrMatch = text.match(/Premises:[\s\S]*?address:[\s\S]*?([0-9].*?21[0-9]{3})/i);

// Populate the "Old Rent" box by default
if(rentMatch) document.getElementById('rentLedgerJan').value = rentMatch[1].replace(/[$,]/g,'');
if(nameMatch) document.getElementById('scanTenant').value = nameMatch[1].trim();
if(addrMatch) document.getElementById('scanAddress').value = addrMatch[1].replace(/\s+/g, ' ').trim();
document.getElementById('verificationCard').style.display = 'block';
} catch(e) { alert("Error reading PDF"); }
document.getElementById('loadingOverlay').style.display = 'none';
}

async function processLedger(input) {
document.getElementById('loadingOverlay').style.display = 'flex';
const text = await extractText(input.files[0]);
document.getElementById('ledgerStatus').innerText = "‚úÖ Ready";
EXTRACTED_LEDGER = [];
const lines = text.split(/(\d{1,2}\/\d{1,2}\/\d{4})/);
for(let i=1; i<lines.length; i+=2) {
const date = lines[i];
const rest = lines[i+1];
const amtMatch = rest.match(/-?[0-9,]+\.[0-9]{2}/g);
if(amtMatch) {
const amount = parseFloat(amtMatch[0].replace(',',''));
let type = 'Other';
if(rest.toLowerCase().includes('rent')) type = 'Base Rent';
EXTRACTED_LEDGER.push({ date, amount, type });
}
}
document.getElementById('loadingOverlay').style.display = 'none';
}

function processPMAgreement(input) { document.getElementById('pmStatus').innerText = "‚úÖ Ready"; }

function processOwnerStmt(input) {
Papa.parse(input.files[0], {
header: false,
skipEmptyLines: true,
complete: function(results) {
OWNER_STMT_DATA = results.data;
document.getElementById('stmtStatus').innerText = "‚úÖ " + results.data.length + " Rows";
if(results.data[1] && results.data[1][0]) document.getElementById('mgmtPropName').value = results.data[1][0];
}
});
}

// --- HELPER ---
function isOccupied(txnDate, start, end, isOngoing) {
if(!start) return true;
const d = new Date(txnDate);
const s = new Date(start);
if(isOngoing) return d >= s;
if(!end) return d >= s;
const e = new Date(end);
return d >= s && d <= e;
}

// --- AUDIT LOGIC 1: TENANT LEDGER (UPDATED SMART RENT LOGIC) ---
function runAuditLogic() {
const rentJan = parseFloat(document.getElementById('rentLedgerJan').value) || 0;
const rentDec = parseFloat(document.getElementById('rentLedgerDec').value) || rentJan; // Default to Jan
const tenant = document.getElementById('scanTenant').value;
const va = document.getElementById('assignVA').value || "Unassigned";

let errors = [];
let passCount = 0;

EXTRACTED_LEDGER.forEach(row => {
if(row.type === 'Base Rent') {
// Check if payment matches EITHER the Old Rent OR the New Rent
const matchOld = Math.abs(row.amount - rentJan) <= 1;
const matchNew = Math.abs(row.amount - rentDec) <= 1;

if (!matchOld && !matchNew) {
errors.push(`Rent mismatch on ${row.date}: Paid $${row.amount}. Expected $${rentJan} or $${rentDec}`);
} else {
passCount++;
}
}
});

LAST_AUDIT_DATA = { type: 'Tenant Ledger', subject: tenant, va: va, errors: errors, content: errors.length ? errors.join('<br>') : `Verified ${passCount} rent payments. All match.` };
displayResults(errors, tenant, va, "Tenant Ledger");
}

// --- AUDIT LOGIC 2: MANAGEMENT FEE ---
function runMgmtAudit() {
const rentJan = parseFloat(document.getElementById('rentJan').value) || 0;
const rentDec = parseFloat(document.getElementById('rentDec').value) || rentJan;
const feePct = parseFloat(document.getElementById('mgmtFeePct').value) || 0;
const propName = document.getElementById('mgmtPropName').value;
const va = document.getElementById('assignVAMgmt').value || "Unassigned";

const leaseStart = document.getElementById('leaseStart').value;
const leaseEnd = document.getElementById('leaseEnd').value;
const isOngoing = document.getElementById('monthToMonth').checked;

const expectedFeeA = (rentJan * (feePct / 100)).toFixed(2);
const expectedFeeB = (rentDec * (feePct / 100)).toFixed(2);

let errors = [];
let feesFound = [];
let duplicateTracker = new Set();
let managementFeeRows = [];

OWNER_STMT_DATA.forEach((row, index) => {
if(!row[0] || index < 1) return;

const dateStr = row[0];
const desc = row[4] ? row[4].toString().trim() : "";
const amountVal = row[13];
const amount = Math.abs(parseFloat(amountVal ? amountVal.replace(/[$,]/g,'') : 0));

// Duplicates
if(amount > 0) {
const uniqueKey = `${dateStr}-${desc}-${amount}`;
if(duplicateTracker.has(uniqueKey)) {
if(desc.toLowerCase().includes('fee') || amount > 50) {
errors.push(`‚ö†Ô∏è DUPLICATE CHARGE: ${dateStr} - ${desc} ($${amount}) appears twice.`);
}
}
duplicateTracker.add(uniqueKey);
}

// High Maintenance
if((desc.toLowerCase().includes('repair') || desc.toLowerCase().includes('maint')) && amount > 500) {
errors.push(`‚ÑπÔ∏è High Maintenance Bill: ${dateStr} - $${amount}. Verify markup.`);
}

// Collect Mgmt Fees
if (desc.includes("Management Fees - Other")) {
managementFeeRows.push({ date: dateStr, amount: amount, rowIndex: index + 1 });
}
});

// Vacancy Check
if(managementFeeRows.length === 0) {
if(leaseStart && isOccupied(new Date(), leaseStart, leaseEnd, isOngoing)) {
errors.push("CRITICAL: Unit is Occupied but NO Management Fees found.");
} else {
errors.push("Note: No Management Fees found. Verify unit is Vacant.");
}
}

managementFeeRows.forEach(fee => {
const isActive = isOccupied(fee.date, leaseStart, leaseEnd, isOngoing);

if (!isActive && leaseStart) {
errors.push(`‚ùå Fee charged during VACANCY: ${fee.date} ($${fee.amount}). Check if this is a valid Vacancy Fee.`);
}
else {
const matchOld = Math.abs(fee.amount - expectedFeeA) < 0.05;
const matchNew = Math.abs(fee.amount - expectedFeeB) < 0.05;

if (matchOld || matchNew) {
feesFound.push(`Match $${fee.amount}`);
} else {
feesFound.push(`Mismatch $${fee.amount}`);
errors.push(`‚ùå Fee Mismatch on ${fee.date}: Found $${fee.amount}. Expected $${expectedFeeA} or $${expectedFeeB}.`);
}
}
});

LAST_AUDIT_DATA = { type: 'Management Fee', subject: propName, va: va, errors: errors, content: errors.length ? errors.join('<br>') : 'Fee calculations match expected rates.' };
displayResults(errors, propName, va, "Management Fee", feesFound.map(f => `<span class="badge ${f.includes('Match')?'bg-pass':'bg-fail'}">${f}</span>`));
}

// --- DISPLAY & SAVE ---
function displayResults(errors, subject, va, type, extras=[]) {
const reportDiv = document.getElementById('auditReport');
const emailBox = document.getElementById('emailOutput');
const currentYear = new Date().getFullYear();
let auditTitle = type === "Management Fee" ? `Rental Income Management Fee Audit (${currentYear})` : type;

let html = "";

if(errors.length === 0) {
LAST_AUDIT_DATA.status = 'Pass';
html = `
<div style="text-align:center; padding:20px; background:#e8f5e9; border:2px solid #28a745; border-radius:10px;">
<h3 style="color:#155724; margin-top:0;">${auditTitle}</h3>
<h1 style="color:#28a745; margin:5px 0;">üåü 100% ACCURACY üåü</h1>
<p style="font-size:1.1rem; color:#155724;">Property: <strong>${subject}</strong></p>
<div style="margin-top:10px;">${extras.join(' ')}</div>
</div>`;

emailBox.value = `Subject: ‚úÖ QC PASSED: ${subject} - ${auditTitle}\n\nHi ${va},\n\nI have completed the ${auditTitle} for ${subject}.\n\nüåü Score: 100% (Passed)\n\nGreat attention to detail. The fees were calculated correctly according to the agreement.\n\nKeep up the fantastic work!\n\nAudited by: ${CURRENT_ROLE}`;

} else {
LAST_AUDIT_DATA.status = 'Fail';
html = `
<div style="padding:15px; background:#fff3cd; border-left:5px solid #ffc107; border-radius:5px;">
<h3 style="margin-top:0; color:#856404;">‚ö†Ô∏è ${auditTitle} - Findings</h3>
<p><strong>Property:</strong> ${subject}</p>
<ul style="margin:0; padding-left:20px; color:#856404;">${errors.map(e => `<li>${e}</li>`).join('')}</ul>
<div style="margin-top:10px;">${extras.join(' ')}</div>
</div>
<div style="margin-top:15px; font-weight:bold;">üëâ Next Steps: Please issue a credit or adjustment immediately.</div>`;

emailBox.value = `Subject: ‚ö†Ô∏è ACTION REQUIRED: ${auditTitle} Failed - ${subject}\n\nHi ${va},\n\nThe ${auditTitle} for ${subject} has flagged the following errors:\n\n${errors.map(e => `- ${e}`).join('\n')}\n\nNEXT STEPS:\n1. Please review the Owner Statement.\n2. Issue a manual adjustment/credit to correct the fee.\n3. Reply to this email once complete.\n\nThank you,\n${CURRENT_ROLE}`;
}

reportDiv.innerHTML = html;
document.getElementById('resultsCard').style.display = 'block';
}

function saveAudit() {
AUDIT_COUNTER++;
const id = AUDIT_COUNTER;
const date = new Date().toLocaleDateString();
AUDIT_HISTORY[id] = { ...LAST_AUDIT_DATA, date: date, id: id, auditor: CURRENT_ROLE };

const table = document.getElementById('historyBody');
const row = table.insertRow(0);
const badgeClass = LAST_AUDIT_DATA.status === 'Pass' ? 'bg-pass' : 'bg-fail';

row.innerHTML = `
<td>${date}</td>
<td>${LAST_AUDIT_DATA.type}</td>
<td>${LAST_AUDIT_DATA.subject}</td>
<td>${LAST_AUDIT_DATA.va}</td>
<td><span class="badge ${badgeClass}">${LAST_AUDIT_DATA.status.toUpperCase()}</span></td>
<td>
<button class="btn btn-outline" style="padding:4px 8px;" onclick="downloadPDF(${id})" title="Download PDF"><i class="fas fa-file-pdf" style="color:#d32f2f;"></i> PDF</button>
<button class="btn btn-outline" style="padding:4px 8px;" onclick="deleteRow(this)" title="Delete"><i class="fas fa-trash" style="color:#555;"></i></button>
</td>
`;

alert("Audit saved! You can now download the PDF Report from the Log.");
showTab('historyTab');
}

function deleteRow(btn) {
if(confirm("Are you sure you want to delete this audit log?")) {
const row = btn.parentNode.parentNode;
row.parentNode.removeChild(row);
}
}

function downloadPDF(id) {
const data = AUDIT_HISTORY[id];
if(!data) return alert("Error: Data not found.");

document.getElementById('pdf-date').innerText = data.date;
document.getElementById('pdf-type').innerText = data.type;
document.getElementById('pdf-subject').innerText = data.subject;
document.getElementById('pdf-auditor').innerText = data.auditor;

const statusDiv = document.getElementById('pdf-status');
if(data.status === 'Pass') {
statusDiv.innerText = "PASS - 100% ACCURACY";
statusDiv.className = "pdf-status-box pdf-pass";
} else {
statusDiv.innerText = "FAIL - DISCREPANCIES FOUND";
statusDiv.className = "pdf-status-box pdf-fail";
}

document.getElementById('pdf-content').innerHTML = data.content;

const element = document.getElementById('pdf-template');
element.style.display = 'block';

const opt = {
margin: 0.5,
filename: `Audit_Report_${data.subject}_${data.date.replace(/\//g,'-')}.pdf`,
image: { type: 'jpeg', quality: 0.98 },
html2canvas: { scale: 2 },
jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
};

html2pdf().set(opt).from(element).save().then(() => {
element.style.display = 'none';
});
}

function sendEmailApp() {
const body = encodeURIComponent(document.getElementById('emailOutput').value);
window.location.href = `mailto:?subject=QC Audit Results&body=${body}`;
}

function copyEmail() {
document.getElementById("emailOutput").select();
document.execCommand("copy");
alert("Email text copied!");
}

function renderHistory() {}
</script>
</body>
</html>
