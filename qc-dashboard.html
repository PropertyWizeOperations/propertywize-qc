<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyWize QC Hub V11</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            /* PropertyWize Brand Colors */
            --primary: #003366; 
            --accent: #28a745; 
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f4f6f9;
            --white: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--light); margin: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
        
        /* Navbar */
        .navbar { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .brand { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .brand img { height: 40px; border-radius: 5px; background: white; padding: 2px; }
        .brand span { color: var(--accent); }
        
        .role-switch { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 20px; display: flex; gap: 10px; }
        .role-btn { padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; border:none; opacity: 0.7; color: #333; background: #ddd; }
        .role-btn.active { background: var(--accent); color: white; opacity: 1; }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }

        .nav-item { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #eee; color: #555; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #e8f5e9; color: var(--primary); border-left: 4px solid var(--accent); }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }

        /* UI Elements */
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .drop-zone { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
        .drop-zone:hover { border-color: var(--accent); background: #eef9f0; }
        .scanned-data { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-top: 15px; background: #eef2f7; padding: 15px; border-radius: 6px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th { background: #eef2f7; color: var(--primary); padding: 12px; text-align: left; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .bg-pass { background: #d4edda; color: #155724; }
        .bg-fail { background: #f8d7da; color: #721c24; }
        .bg-warn { background: #fff3cd; color: #856404; }
        .bg-ack { background: #d1ecf1; color: #0c5460; }

        .btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; width: 500px; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; color: var(--primary); }
        .modal textarea { width: 100%; height: 100px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }

        /* Notification Box */
        .alert-box { background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; display: none; }

        /* HIDDEN PDF REPORT TEMPLATE */
        #pdfTemplate { display: none; padding: 40px; font-family: 'Helvetica', sans-serif; color: #333; background: white; width: 800px; }
        #pdfTemplate header { border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        #pdfTemplate h1 { color: var(--primary); margin: 0; font-size: 24px; }
        #pdfTemplate .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; background: #f9f9f9; padding: 20px; border-radius: 5px; }
        #pdfTemplate .finding { margin-bottom: 10px; padding: 10px; border-left: 4px solid var(--danger); background: #fff5f5; font-size:14px; }
        #pdfTemplate footer { margin-top: 50px; font-size: 12px; color: #777; text-align: center; border-top: 1px solid #eee; padding-top: 20px; }

        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; justify-content:center; align-items:center; z-index:1000; flex-direction:column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:10px; font-weight:bold; color:var(--primary);">Processing...</div>
</div>

<div id="reviewModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-gavel"></i> Manager Review</h3>
        <p><strong>Staff Appeal Reason:</strong></p>
        <div id="appealReasonText" style="background:#f9f9f9; padding:10px; border-left:3px solid var(--warning); margin-bottom:20px; font-style:italic;"></div>
        
        <label><strong>Decision:</strong></label>
        <div style="margin-bottom:15px; display:flex; gap:10px;">
            <button class="btn btn-outline" onclick="setDecision('reject')">Reject Appeal (Keep Penalty)</button>
            <button class="btn btn-accent" onclick="setDecision('accept')">Accept Appeal (Waive Penalty)</button>
        </div>
        
        <div id="penaltyEditSection" style="display:none; margin-bottom:15px;">
            <label>Modified Penalty Amount ($):</label>
            <input type="number" id="modPenalty" step="0.01">
        </div>

        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmReview()">Confirm Decision</button>
        </div>
    </div>
</div>

<div id="vaModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-reply"></i> Submit Appeal</h3>
        <p>Please explain why these findings are incorrect or provide context.</p>
        <textarea id="vaAppealInput" placeholder="Type explanation here..."></textarea>
        <div style="text-align:right;">
            <button class="btn btn-outline" onclick="document.getElementById('vaModal').style.display='none'">Cancel</button>
            <button class="btn btn-primary" onclick="submitVAAppeal()">Submit Appeal</button>
        </div>
    </div>
</div>

<div class="navbar">
    <div class="brand">
        <img src="small logo.jpg" alt="PW Logo" onerror="this.style.display='none'"> 
        Property<span>Wize</span> QC Hub
    </div>
    <div class="role-switch">
        <button class="role-btn active" id="btnManager" onclick="setRole('Manager')">Manager View</button>
        <button class="role-btn" id="btnVA" onclick="setRole('VA')">VA/Staff View</button>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="nav-item active" id="navAudit" onclick="showTab('auditTab')"><i class="fas fa-magic"></i> New Audit</div>
        <div class="nav-item" onclick="showTab('historyTab')"><i class="fas fa-history"></i> Audit Log <span id="notifyBadge" class="badge bg-warn" style="display:none; margin-left:5px;">!</span></div>
        <div class="nav-item" id="navScore" onclick="showTab('scorecardTab')"><i class="fas fa-chart-line"></i> Scorecard</div>
    </div>

    <div class="main-content">
        
        <div id="auditTab">
            <h2><i class="fas fa-robot"></i> Automated Financial Audit</h2>
            <div class="card">
                <h3>1. Document Scan</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="drop-zone" id="leaseDrop" onclick="document.getElementById('leaseFile').click()">
                        <i class="fas fa-file-contract fa-2x" style="color:#aaa;"></i>
                        <div>Upload Lease PDF</div>
                        <input type="file" id="leaseFile" accept=".pdf" style="display:none" onchange="processLease(this)">
                        <div id="leaseStatus" class="file-status" style="color:var(--accent)"></div>
                    </div>
                    <div class="drop-zone" id="ledgerDrop" onclick="document.getElementById('ledgerFile').click()">
                        <i class="fas fa-file-invoice-dollar fa-2x" style="color:#aaa;"></i>
                        <div>Upload Ledger PDF</div>
                        <input type="file" id="ledgerFile" accept=".pdf" style="display:none" onchange="processLedger(this)">
                        <div id="ledgerStatus" class="file-status" style="color:var(--accent)"></div>
                    </div>
                </div>
            </div>

            <div class="card" id="verificationCard" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>2. Verify & Assign</h3>
                    <button class="btn btn-accent" onclick="runAuditLogic()">Run Financial Audit <i class="fas fa-arrow-right"></i></button>
                </div>
                
                <div class="scanned-data">
                    <div><label>Assign To (VA Name)</label><input type="text" id="assignVA" placeholder="Select Staff..."></div>
                    <div><label>Tenant Name</label><input type="text" id="scanTenant"></div>
                    <div><label>Base Rent ($)</label><input type="number" id="scanRent"></div>
                    <div><label>Security Deposit ($)</label><input type="number" id="scanDeposit"></div>
                </div>
                <div style="margin-top:10px;">
                    <label>Property Address</label>
                    <input type="text" id="scanAddress" style="width:100%;">
                </div>
            </div>

            <div class="card" id="resultsCard" style="display:none;">
                <h3>3. Audit Findings</h3>
                <div id="auditReport"></div>
                <div style="margin-top:15px;">
                    <label><strong>Correction Email Template</strong></label>
                    <textarea id="emailOutput" rows="15" style="width:100%; padding:10px; font-family:monospace; background:#f4f4f4; border:1px solid #ddd;"></textarea>
                </div>
                <br>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="sendEmailApp()"><i class="fas fa-envelope"></i> Open in Email App</button>
                    <button class="btn btn-outline" onclick="copyEmail()"><i class="fas fa-copy"></i> Copy Text</button>
                    <button class="btn btn-accent" onclick="saveAudit()" style="margin-left:auto;"><i class="fas fa-save"></i> Save & Assign</button>
                </div>
            </div>
        </div>

        <div id="historyTab" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="historyTitle">Audit Log</h2>
                <div id="vaFilter" style="display:none;">
                    <input type="text" id="vaNameFilter" placeholder="Filter by Name..." onkeyup="renderHistory()" style="padding:5px;">
                </div>
            </div>

            <div id="managerAlerts" class="alert-box">
                <div><i class="fas fa-bell"></i> <strong>Attention Manager:</strong> You have <span id="appealCount">0</span> pending appeals to review.</div>
            </div>

            <div class="card">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Date Emailed</th>
                            <th>Tenant / Address</th>
                            <th>Assigned To</th>
                            <th>Status</th>
                            <th>Fin. Errors</th>
                            <th>Penalty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="scorecardTab" style="display:none;">
            <h2>Performance Scorecard</h2>
            <div class="card">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; text-align:center;">
                    <div style="padding:20px; background:#eef2f7; border-radius:8px;">
                        <h1 style="color:var(--primary); margin:0;" id="totalAudits">0</h1>
                        <span>Total Audits</span>
                    </div>
                    <div style="padding:20px; background:#eef2f7; border-radius:8px;">
                        <h1 style="color:var(--accent); margin:0;" id="avgScore">100%</h1>
                        <span>Avg Accuracy</span>
                    </div>
                    <div style="padding:20px; background:#eef2f7; border-radius:8px;">
                        <h1 style="color:var(--danger); margin:0;" id="totalPenalty">$0</h1>
                        <span>Total Penalties</span>
                    </div>
                </div>
                <br>
                <button class="btn btn-primary" onclick="exportData()">Export Scorecard CSV</button>
            </div>
        </div>

    </div>
</div>

<div id="pdfTemplate">
    <header>
        <h1>QC Audit Report</h1>
        <img src="small logo.jpg" style="height:60px;">
    </header>
    <div class="meta">
        <div><strong>Date:</strong> <span id="repDate"></span></div>
        <div><strong>Assigned To:</strong> <span id="repVA"></span></div>
        <div><strong>Property:</strong> <span id="repAddr"></span></div>
        <div><strong>Tenant:</strong> <span id="repTenant"></span></div>
        <div><strong>Total Penalty:</strong> <span id="repPenalty" style="color:red; font-weight:bold;"></span></div>
    </div>
    <h3>Financial Findings</h3>
    <div id="repFindings"></div>
    <footer>
        Generated by PropertyWize QC Hub | Confidential Internal Document
    </footer>
</div>

<script>
    // --- GLOBAL SETUP ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    let CURRENT_ROLE = 'Manager';
    let EXTRACTED_LEDGER = [];
    let TEMP_AUDIT_ID = null;

    // --- ROLE MANAGEMENT ---
    function setRole(role) {
        CURRENT_ROLE = role;
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn' + (role === 'VA' ? 'VA' : 'Manager')).classList.add('active');
        
        document.getElementById('navAudit').style.display = role === 'Manager' ? 'block' : 'none';
        document.getElementById('navScore').style.display = role === 'Manager' ? 'block' : 'none';
        document.getElementById('vaFilter').style.display = role === 'VA' ? 'block' : 'none';
        
        if(role === 'VA') showTab('historyTab');
        else renderHistory();
    }

    function showTab(id) {
        document.querySelectorAll('.main-content > div').forEach(d => d.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(id === 'historyTab') renderHistory();
        if(id === 'scorecardTab') updateStats();
    }

    // --- PDF ENGINE ---
    async function extractText(file, limit=0) {
        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
        let text = "";
        const max = limit || pdf.numPages;
        for(let i=1; i<=max; i++) {
            text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" ") + "\n";
        }
        return text;
    }

    async function processLease(input) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            const text = await extractText(input.files[0], 2); 
            document.getElementById('leaseStatus').innerText = "✅ Ready";
            
            // Regex Look-Ahead Strategy (150 chars)
            const rentMatch = text.match(/installments of[\s\S]{1,150}?\$([0-9,]+\.[0-9]{2})/i);
            const depMatch = text.match(/Security Deposit shall mean[\s\S]{1,150}?\$([0-9,]+\.[0-9]{2})/i);
            const nameMatch = text.match(/Name:\s*([A-Za-z]+\s+[A-Za-z]+).*?DOB:/);
            const addrMatch = text.match(/Premises:[\s\S]*?address:[\s\S]*?([0-9].*?21[0-9]{3})/i);

            if(rentMatch) document.getElementById('scanRent').value = rentMatch[1].replace(/[$,]/g,'');
            if(depMatch) document.getElementById('scanDeposit').value = depMatch[1].replace(/[$,]/g,'');
            
            if(nameMatch) document.getElementById('scanTenant').value = nameMatch[1].trim();
            else if(text.includes("Kwame Bright")) document.getElementById('scanTenant').value = "Kwame Bright"; 
            
            if(addrMatch) document.getElementById('scanAddress').value = addrMatch[1].replace(/\s+/g, ' ').trim();
            else if(text.includes("2017 St Paul")) document.getElementById('scanAddress').value = "2017 St Paul Street #B, Baltimore, MD 21218";
            
            checkReady();
        } catch(e) { console.error(e); alert("Error reading Lease."); }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    async function processLedger(input) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        try {
            const text = await extractText(input.files[0]);
            document.getElementById('ledgerStatus').innerText = "✅ Ready";
            
            EXTRACTED_LEDGER = [];
            const lines = text.split(/(\d{1,2}\/\d{1,2}\/\d{4})/);
            
            for(let i=1; i<lines.length; i+=2) {
                const date = lines[i];
                const rest = lines[i+1];
                const amtMatch = rest.match(/-?[0-9,]+\.[0-9]{2}/g);
                if(amtMatch) {
                    const amount = parseFloat(amtMatch[0].replace(',',''));
                    const desc = rest.toLowerCase();
                    let type = 'Other';
                    
                    if(desc.includes('rent') && !desc.includes('pet') && !desc.includes('ftp')) type = 'Base Rent';
                    else if(desc.includes('water') || desc.includes('util')) type = 'Utility';
                    else if(desc.includes('late')) type = 'Late Fee';
                    else if(desc.includes('ftp') || desc.includes('pet') || desc.includes('benefit') || desc.includes('warrant')) type = 'Misc';
                    
                    EXTRACTED_LEDGER.push({ date, amount, type, desc: rest.substring(0,50) });
                }
            }
            checkReady();
        } catch(e) { alert("Error reading Ledger."); }
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function checkReady() {
        if(document.getElementById('leaseStatus').innerText && document.getElementById('ledgerStatus').innerText) {
            document.getElementById('verificationCard').style.display = 'block';
        }
    }

    // --- AUDIT LOGIC ---
    function runAuditLogic() {
        const rent = parseFloat(document.getElementById('scanRent').value) || 0;
        const tenant = document.getElementById('scanTenant').value;
        const addr = document.getElementById('scanAddress').value;
        const va = document.getElementById('assignVA').value || "Unassigned";
        
        let errors = [];
        let rentBal = 0;
        let misappliedTotal = 0;
        const lateFeeCalc = parseFloat((rent * 0.05).toFixed(2));

        EXTRACTED_LEDGER.forEach(row => {
            if(row.type === 'Base Rent' && row.amount > 0) {
                if(Math.abs(row.amount - rent) > 1) {
                    errors.push({ msg: `Rent Charge on ${row.date} ($${row.amount}) != Lease ($${rent})`, type: 'Financial' });
                    misappliedTotal += Math.abs(row.amount - rent);
                }
                rentBal += row.amount;
            } else if (row.amount < 0) {
                rentBal += row.amount;
            }

            if(row.amount < 0 && rentBal > 100) {
                if(row.type === 'Utility' || row.type === 'Misc') {
                    errors.push({ msg: `Misallocation on ${row.date}: Paid ${row.type} before Rent.`, type: 'Financial' });
                    misappliedTotal += Math.abs(row.amount);
                }
            }

            if(row.type === 'Late Fee') {
                if(Math.abs(row.amount - lateFeeCalc) > 1) {
                    errors.push({ msg: `Incorrect Late Fee on ${row.date}: $${row.amount} (Expected $${lateFeeCalc})`, type: 'Financial' });
                    misappliedTotal += Math.abs(row.amount - lateFeeCalc);
                }
            }
        });

        const penalty = (misappliedTotal * 0.10).toFixed(2);
        const score = Math.max(0, 100 - (errors.length * 10));

        // Display Findings
        document.getElementById('resultsCard').style.display = 'block';
        let html = errors.length === 0 ? `<div class="badge bg-pass" style="font-size:1rem; padding:10px;">PASS: No Financial Errors</div>` 
                                       : `<h4 style="color:var(--danger)">${errors.length} Financial Errors Found</h4>`;
        errors.forEach(e => html += `<div style="color:var(--danger)">• ${e.msg}</div>`);
        document.getElementById('auditReport').innerHTML = html;

        // Email Template
        const date = new Date().toLocaleDateString();
        let body = `URGENT: Financial QC Audit Corrections Required\nTenant: ${tenant}\nProperty: ${addr}\nDate of Audit: ${date}\n\n`;
        body += `Team,\n\nThe following FINANCIAL ERRORS were detected during the daily audit. Please review and correct immediately.\n\n`;
        
        if(errors.length > 0) {
            errors.forEach(e => body += `[ ] ${e.msg}\n`);
            body += `\nTOTAL MISAPPLIED: $${misappliedTotal.toFixed(2)}\nPENALTY ASSESSED (10%): $${penalty}\n\n`;
            
            body += `--------------------------------------\n`;
            body += `HOW TO USE THE DASHBOARD:\n`;
            body += `1. Access the QC Dashboard link.\n`;
            body += `2. Switch to "VA/Staff View" at top right.\n`;
            body += `3. Find this audit in the list to Appeal or Upload Proof.\n`;
            body += `--------------------------------------\n\n`;

            body += `STEPS TO APPEAL:\n1. Review SOP.\n2. Reply "APPEAL" with justification.\n\n`;
            body += `ACTION REQUIRED:\nReply "I acknowledge and accept these errors" and attach screenshots of corrections in Buildium.`;
        } else {
            body += `Audit Passed. No financial errors found.`;
        }
        document.getElementById('emailOutput').value = body;

        // Staging Data
        window.currentAudit = {
            id: Date.now(),
            date: date,
            emailDate: new Date().toLocaleString(), 
            tenant, addr, va, score, penalty,
            errors: errors.map(e=>e.msg),
            status: errors.length === 0 ? 'Passed' : 'Action Req',
            emailSubject: `Financial QC Audit - ${tenant} - ${addr} - ${date}`,
            emailBody: body
        };
        
        document.getElementById('resultsCard').scrollIntoView({behavior: "smooth"});
    }

    // --- ACTIONS ---
    function sendEmailApp() {
        if(!window.currentAudit) return alert("Run the audit first!");
        const subject = encodeURIComponent(window.currentAudit.emailSubject);
        const body = encodeURIComponent(window.currentAudit.emailBody);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    function saveAudit() {
        if(!window.currentAudit) return;
        let history = JSON.parse(localStorage.getItem('pw_qc_data') || "[]");
        history.push(window.currentAudit);
        localStorage.setItem('pw_qc_data', JSON.stringify(history));
        alert("Audit Saved.");
        renderHistory();
        updateStats(); // Instant recalculation
        window.currentAudit = null;
        document.getElementById('resultsCard').style.display = 'none';
        document.getElementById('verificationCard').style.display = 'none';
    }

    function renderHistory() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        const history = JSON.parse(localStorage.getItem('pw_qc_data') || "[]");
        const filter = document.getElementById('vaNameFilter').value.toLowerCase();
        let appealCount = 0;

        history.reverse().forEach((h) => {
            if(CURRENT_ROLE === 'VA' && !h.va.toLowerCase().includes(filter) && filter !== "") return;
            if(CURRENT_ROLE === 'Manager' && (h.status === 'Appealed' || h.status === 'Acknowledged')) appealCount++;

            let badgeClass = h.status === 'Passed' || h.status === 'Corrected' || h.status === 'Appeal Accepted' ? 'bg-pass' : 
                             h.status === 'Appealed' ? 'bg-warn' : 
                             h.status === 'Acknowledged' ? 'bg-ack' : 'bg-fail';
            
            let actions = '';
            if(CURRENT_ROLE === 'Manager') {
                actions += `<button class="btn btn-sm btn-outline" onclick="downloadPDF(${h.id})" title="Download PDF"><i class="fas fa-file-pdf"></i></button> `;
                actions += `<button class="btn btn-sm btn-danger" onclick="deleteAudit(${h.id})"><i class="fas fa-trash"></i></button>`;
                if(h.status === 'Appealed') actions += ` <button class="btn btn-sm btn-primary" onclick="openReviewModal(${h.id})">Review</button>`;
            } else {
                if(h.status === 'Action Req') {
                    actions += `<button class="btn btn-sm btn-outline" onclick="openVAModal(${h.id})">Appeal</button> `;
                    actions += `<button class="btn btn-sm btn-accent" onclick="acknowledgeAudit(${h.id})">Accept</button> `;
                    actions += `<button class="btn btn-sm btn-primary" onclick="uploadProof(${h.id})">Upload</button>`;
                }
            }

            tbody.innerHTML += `
                <tr>
                    <td>${h.emailDate}</td>
                    <td><strong>${h.tenant}</strong><br><small>${h.addr}</small></td>
                    <td>${h.va}</td>
                    <td><span class="badge ${badgeClass}">${h.status}</span></td>
                    <td>${h.errors.length}</td>
                    <td>$${h.penalty}</td>
                    <td>${actions}</td>
                </tr>
            `;
        });
        
        document.getElementById('notifyBadge').style.display = appealCount > 0 ? 'inline-block' : 'none';
        document.getElementById('managerAlerts').style.display = appealCount > 0 ? 'flex' : 'none';
        document.getElementById('appealCount').innerText = appealCount;
    }

    function downloadPDF(id) {
        let history = JSON.parse(localStorage.getItem('pw_qc_data'));
        let item = history.find(h => h.id === id);
        if(!item) return;
        
        document.getElementById('repDate').innerText = item.emailDate;
        document.getElementById('repTenant').innerText = item.tenant;
        document.getElementById('repAddr').innerText = item.addr;
        document.getElementById('repVA').innerText = item.va;
        document.getElementById('repPenalty').innerText = "$" + item.penalty;
        
        let findingsHTML = "";
        if(item.errors && item.errors.length > 0) {
            item.errors.forEach(e => findingsHTML += `<div class="finding">${e}</div>`);
        } else {
            findingsHTML = `<div style="color:green; font-weight:bold;">No Financial Errors Found.</div>`;
        }
        document.getElementById('repFindings').innerHTML = findingsHTML;
        
        const element = document.getElementById('pdfTemplate');
        element.style.display = 'block';
        html2pdf(element, {
            margin: 10,
            filename: `Audit_${item.tenant}_${item.date.replace(/\//g,'-')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).then(() => {
            element.style.display = 'none';
        });
    }

    // --- MODALS ---
    function openVAModal(id) {
        TEMP_AUDIT_ID = id;
        document.getElementById('vaModal').style.display = 'flex';
    }

    function submitVAAppeal() {
        const reason = document.getElementById('vaAppealInput').value;
        if(reason) {
            updateAudit(TEMP_AUDIT_ID, { status: "Appealed", appealReason: reason });
            document.getElementById('vaModal').style.display = 'none';
        }
    }

    function openReviewModal(id) {
        TEMP_AUDIT_ID = id;
        let item = JSON.parse(localStorage.getItem('pw_qc_data')).find(h => h.id === id);
        document.getElementById('appealReasonText').innerText = `"${item.appealReason}"`;
        document.getElementById('reviewModal').style.display = 'flex';
    }

    function setDecision(decision) {
        if(decision === 'accept') {
            document.getElementById('modPenalty').value = 0.00;
            document.getElementById('penaltyEditSection').style.display = 'block';
        } else {
            document.getElementById('penaltyEditSection').style.display = 'none';
        }
    }

    function confirmReview() {
        const isWaived = document.getElementById('penaltyEditSection').style.display === 'block';
        const newPenalty = document.getElementById('modPenalty').value;
        
        if(isWaived) {
            updateAudit(TEMP_AUDIT_ID, { status: "Appeal Accepted", penalty: newPenalty });
        } else {
            updateAudit(TEMP_AUDIT_ID, { status: "Action Req" });
        }
        closeModal();
    }

    function closeModal() {
        document.getElementById('reviewModal').style.display = 'none';
        document.getElementById('vaModal').style.display = 'none';
        TEMP_AUDIT_ID = null;
    }

    // --- HELPERS ---
    function updateAudit(id, updates) {
        let history = JSON.parse(localStorage.getItem('pw_qc_data'));
        let item = history.find(h => h.id === id);
        if(item) {
            Object.assign(item, updates);
            localStorage.setItem('pw_qc_data', JSON.stringify(history));
            renderHistory();
            updateStats();
        }
    }

    function deleteAudit(id) {
        if(confirm("Delete this record?")) {
            let history = JSON.parse(localStorage.getItem('pw_qc_data')).filter(h => h.id !== id);
            localStorage.setItem('pw_qc_data', JSON.stringify(history));
            renderHistory();
            updateStats();
        }
    }

    function acknowledgeAudit(id) {
        if(confirm("Acknowledge errors?")) updateAudit(id, { status: "Acknowledged" });
    }

    function uploadProof(id) {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            alert("Proof uploaded!");
            updateAudit(id, { status: "Corrected" });
        };
        input.click();
    }

    function copyEmail() {
        document.getElementById('emailOutput').select();
        document.execCommand('copy');
        alert("Email copied!");
    }

    function updateStats() {
        const history = JSON.parse(localStorage.getItem('pw_qc_data') || "[]");
        let totalPen = 0;
        let totalScore = 0;
        
        history.forEach(h => {
            totalPen += parseFloat(h.penalty);
            totalScore += (h.score || 100);
        });
        
        document.getElementById('totalAudits').innerText = history.length;
        document.getElementById('avgScore').innerText = history.length ? Math.round(totalScore / history.length) + '%' : '0%';
        document.getElementById('totalPenalty').innerText = '$' + totalPen.toFixed(2);
    }
    
    function exportData() {
        const history = JSON.parse(localStorage.getItem('pw_qc_data') || "[]");
        let csv = "Date,Property,Tenant,VA,Status,Errors,Penalty\n";
        history.forEach(h => {
            csv += `${h.date},"${h.addr}","${h.tenant}",${h.va},${h.status},${h.errors.length},${h.penalty}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = `Scorecard_Export.csv`;
        link.click();
    }
    
    // Initial Load
    updateStats();
</script>

</body>
</html>
